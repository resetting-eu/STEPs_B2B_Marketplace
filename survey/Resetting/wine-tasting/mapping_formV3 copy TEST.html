<!DOCTYPE html>
<html>
  <head>

    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>Contributos wine_tasting</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <style type="text/css">
      html {
        height: 100%;
      }
      body {
        height: 100%;
        margin: 0px;
        padding: 0px;
      }
      #map_canvas {
        height: 100%;
      }
      /* bootstrap fix */
      #map_canvas img {
        max-width: none;
      }


      #floating-panel_directions {
  position: absolute;
  top: 0px;
  left: 30%;
  z-index: 5;
  background-color: #fff;
  padding: 5px;
  border: 1px solid #999;
  text-align: center;
  font-family: "Roboto", "sans-serif";
  line-height: 30px;
  padding-left: 10px;
  display: none;
}

#floating-panel_areas {
  position: absolute;
  top: 0px;
  left: 30%;
  z-index: 5;
  background-color: #fff;
  padding: 5px;
  border: 1px solid #999;
  text-align: center;
  font-family: "Roboto", "sans-serif";
  line-height: 30px;
  padding-left: 10px;
  display: none;
}

#floating-panel_sources {
  position: absolute;
  top: 0px;
  left: 30%;
  z-index: 5;
  background-color: #fff;
  padding: 5px;
  border: 1px solid #999;
  text-align: center;
  font-family: "Roboto", "sans-serif";
  line-height: 30px;
  padding-left: 10px;
  display: none;
}


#pac-input {
  max-width: 200x;
  width: 97%;
  min-width: 50px;
}

.gm-style-iw-a {
  position: relative !important;
}

    </style>
    <!-- Google Maps and Places and Drawing API -->

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <!-- truf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js" integrity="sha512-Q7HOppxoH0L2M7hreVoFCtUZimR2YaY0fBewIYzkCgmNtgOOZ5IgMNYxHgfps0qrO1ef5m7L1FeHrhXlq1I9HA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- bootstrap -->
    <!-- <link rel="stylesheet" type="text/css" href="css/participeapi.css" /> -->
    <style>
      body,
      html {
        height: 100%;
        width: 100%;
        display: flex;
      }

      body {
        color: rgba(6, 80, 73, 1);
        font: normal normal 1em/1em "PT Sans", Helvetica, Arial, Verdana,
          sans-serif;
      }
      .control-label {
        font-size: 1em;
        padding: 2px 0 0 0;
      }
      .input-xlarge {
        border-radius: 6px;
        display: block;
        border: 2px solid #dddddd;
        width: 95%;
        padding: 1px;
      }
      .input-xlargeL1 {
        border-radius: 6px;
        display: block;
        border: 2px solid #dddddd;
        width: 98%;
        height: 150px;
        padding: 1px;
      }
      .input-xlargeL {
        border-radius: 6px;
        display: block;
        border: 2px solid #dddddd;
        width: 98%;
        padding: 1px;
      }
      .btn-primary {
        background-color: rgba(8, 109, 99, 1);
        border-radius: 6px;
        border: 2px solid rgba(6, 80, 73, 1);
        box-shadow: 0 2px 2px #000;
        color: #ffffff;
        display: block;
        float: right;
        font-size: 1.6em;
        padding: 4px;
        font-size: 1.2em;
        text-decoration: none;
        text-shadow: 0 1px 2px #000;
        cursor: pointer;
        position: absolute;
        bottom: 5px;
        right: 70px;
      }
      .botaoacessos {
        background-color: rgba(8, 109, 99, 1);
        border-radius: 6px;
        border: 2px solid rgba(6, 80, 73, 1);
        box-shadow: 0 2px 2px #000;
        color: #ffffff;
        display: block;
        float: right;
        font-size: 1.6em;
        padding: 4px;
        font-size: 1.2em;
        text-decoration: none;
        text-shadow: 0 1px 2px #000;
        cursor: pointer;
        float: none;
      }
      .botaoaceitar {
        background-color: rgba(8, 109, 99, 1);
        border-radius: 6px;
        border: 2px solid rgba(6, 80, 73, 1);
        box-shadow: 0 2px 2px #000;
        color: #ffffff;
        display: block;
        float: right;
        font-size: 1.6em;
        padding: 4px;
        font-size: 1.2em;
        text-decoration: none;
        text-shadow: 0 1px 2px #000;
        cursor: pointer;
        position: absolute;
        bottom: 5px;
        right: 5px;
      }
      .actividades {
        border-radius: 12px;
        display: block;
        border: 2px solid #dddddd;
        width: 470px;
      }
      .actividades.hidesudo {
        display: none;
      }
      .acessos {
        border-radius: 12px;
        display: none;
        border: 2px solid #dddddd;
        width: 470px;
      }
      .acessos.showsudo {
        display: block;
      }

      .mapcanvasstyle {
        /* height: 10px; */
        left: 0;
        position: fixed !important;
        top: 0;
        width: 100dvw;
        z-index: 1;

        height: 100dvh;
        margin: 0;
        padding: 0;
      } /* Has to be at least one increment smaller in value than the container's z-index */

      .submitdiv {
        display: block;
        background: rgba(240, 248, 255, 0.9);
        border: 5px solid rgba(6, 80, 73, 1);
        border-radius: 12px;
        overflow: visible !important;
        padding: 10px;
        position: absolute;
        top: 10px;
        right: 10px;
        width: 320px;
        z-index: 2;
        font-size: 1.4em;
      } /* Has to be at least one increment larger in value than the Google Maps iframe z-index */
      .APIpage_Submit {
        background: rgba(8, 109, 99, 1);
        border-radius: 12px;
        border: 2px solid rgba(6, 80, 73, 1);
        box-shadow: 0 2px 2px #000;
        color: #fff;
        display: block;
        float: right;
        font-size: 1.6em;
        padding-bottom: 18px;
        padding-top: 18px;
        font-size: 1.4em;
        text-decoration: none;
        text-shadow: 0 1px 2px #000;
      }
      input[type="button"]:disabled {
        background: #dddddd;
        border-color: #dddddd;
        color: #dddddd;
      }
      button[type="button"]:disabled {
        background: #dddddd;
        border-color: #dddddd;
        color: #dddddd;
      }
      .gm-style-iw + div {
        display: none;
      }

      /* .gm-style-iw {
        display: block;
        /* width: 100vw !important;
  height:100vh !important;
	   top: 0px !important;
   left: 0px !important; */
   /* width: 100dvw !important; */
        
        /* width: 100dvw !important;
        height:100dvh !important;        
        background-color: #fff;
        border: 4px solid rgba(6, 80, 73, 1);
        border-radius: 12px 12px 12px 12px;
      } */

/* both classes gm-style-iw gm-style-iw-c */
      /* .gm-style-iw-c {
        display: block;
        width: 100dvw !important;
        height:100dvh !important;
        
                top: 0px !important;                
                left: 0px !important;
        background-color: #fff;
        border: 4px solid rgba(6, 80, 73, 1);
        border-radius: 12px 12px 12px 12px;
      } */ */
      .gm-style .gm-style-iw-c {
    max-width: fit-content !important;
    max-height: fit-content !important;
    position: absolute;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    overflow: hidden;
    top: 0;
    left: 0;
    -webkit-transform: translate3d(-50%, -100%, 0);
    transform: translate3d(-50%, -100%, 0);
    background-color: white;
    border-radius: 8px;
    padding: 12px;
    -webkit-box-shadow: 0 2px 7px 1px rgba(0, 0, 0, .3);
    box-shadow: 0 2px 7px 1px rgba(0, 0, 0, .3);
    display: -webkit-box;
    display: -webkit-flex;
    display: flex;
    -webkit-box-orient: vertical;
    -webkit-box-direction: normal;
    -webkit-flex-direction: column;
    flex-direction: column;
}
.gm-style .gm-style-iw {
  max-width: fit-content !important;
    max-height: fit-content !important;
    position: absolute;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    overflow: hidden;
    top: 0;
    left: 0;
    -webkit-transform: translate3d(-50%, -100%, 0);
    transform: translate3d(-50%, -100%, 0);
    background-color: white;
    border-radius: 8px;
    padding: 12px;
    -webkit-box-shadow: 0 2px 7px 1px rgba(0, 0, 0, .3);
    box-shadow: 0 2px 7px 1px rgba(0, 0, 0, .3);
    display: -webkit-box;
    display: -webkit-flex;
    display: flex;
    -webkit-box-orient: vertical;
    -webkit-box-direction: normal;
    -webkit-flex-direction: column;
    flex-direction: column;
}


      .mainDiv {
        /* width: 100dvw;
        height: 100dvh; */

    position: relative !important;
    display: block !important;
    width: 98dvw !important;
    height: 84dvh !important;
    top: 0px !important;
    left: 0px !important;
    background-color: white !important;

      }

      #selector-a {
        color: #fff;
        font-size: 1.4em;
        background-color: #143c00;
        opacity: 0.85;
      }

      #selector-b {
        color: #fff;
        font-size: 1.4em;
        background-color: #14a000;
        opacity: 0.85;
      }

      #selector-c {
        color: #5a5a5a;
        font-size: 1.4em;
        background-color: #14ff00;
        opacity: 0.85;
      }

      #selector-d {
        color: #5a5a5a;
        font-size: 1.4em;
        background-color: #dcdcdc;
        opacity: 0.85;
      }

      #selector-e {
        color: #000000;
        font-size: 1.4em;
        background-color: #ff0000;
        opacity: 0.85;
      }

      /*--------------------------------------------------------------------------------*/
      #drawingControlContainer {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
      }
      #vineyard_drawingControlContainer {
        position: relative;
        top: 0px;
        left: 0px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
      }
      #winery_drawingControlContainer {
        position: relative;
        top: 0px;
        left: 0px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
      }
      .drawButton {
        background: rgb(255, 255, 255) padding-box;
        display: block;
        border: 0px;
        margin: 0px;
        padding: 4px;
        text-transform: none;
        appearance: none;
        position: relative;
        cursor: pointer;
        user-select: none;
        direction: ltr;
        overflow: hidden;
        text-align: left;
        color: rgb(86, 86, 86);
        font-family: Roboto, Arial, sans-serif;
        font-size: 11px;
        box-shadow: rgba(0, 0, 0, 0.3) 0px 1px 4px -1px;
      }

      /* The modaldropback */
      .modal-backdrop.in {
        display: none;
        position: fixed;
        z-index: 0;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);




 };



    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD06VoGtS9XbcWwkqcJx_VmL46nAI9H1vM&loading=async&libraries=places,drawing&v=weekly&callback=mapInitialize">
      //   async
      // defer
      //&callback=wine_tasting.initialize">//
    </script>

    <script>
function getAllElementsFromHtml() {
    let elementsArray = [];

    function traverseDOM(node) {
        if (node) {
            elementsArray.push(node); // Add the current node to the array
            node = node.firstElementChild; // Start with the first child
            while (node) {
                traverseDOM(node); // Recursively traverse the children
                node = node.nextElementSibling; // Move to the next sibling
            }
        }
    }

    traverseDOM(document.documentElement); // Start with the <html> element
    return elementsArray;
}

function gen_page_constructor(element) { 
        let elements = getAllElementsFromHtml(element); 
        let code = 'let promiseChain = Promise.resolve();\n';

    function createPromiseChainForElement(element, varName) {

// deeper check for SVG descendants, did not solve the problems with svgs conatinging xlink:href
    let isSvgDescendant = false;
let parent = element.parentElement;
while (parent) {
    if (parent.tagName.toLowerCase() === 'svg') {
        isSvgDescendant = true;
        break;
    }
    parent = parent.parentElement;
}

if (isSvgDescendant || element.tagName.toLowerCase() === 'svg') {
    // Handle SVG descendants
// chek if the element is an SVG or a descendant of an SVG
if (element.hasAttributeNS('http://www.w3.org/2000/svg', 'xmlns') || element.tagName.toLowerCase() === 'svg' || element.namespaceURI === 'http://www.w3.org/2000/svg') {
    // Create the element with the appropriate namespace if it's an SVG or descendant of an SVG
    if (element.hasAttributeNS('http://www.w3.org/2000/svg', 'xmlns:svg')) {
        code += `var ${varName} = document.createElementNS('http://www.w3.org/2000/svg', '${element.tagName.toLowerCase()}');\n`;
        code += `${varName}.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:svg', 'http://www.w3.org/2000/svg');\n`;
    } else if (element.hasAttributeNS('http://www.w3.org/2000/svg', 'xmlns:xlink')) {
        code += `var ${varName} = document.createElementNS('http://www.w3.org/2000/svg', '${element.tagName.toLowerCase()}');\n`;
        code += `${varName}.setAttributeNS('http://www.w3.org/2000/xmlns/', 'xmlns:xlink', 'http://www.w3.org/1999/xlink');\n`;
    } else  {
        code += `var ${varName} = document.createElementNS('http://www.w3.org/2000/svg', '${element.tagName.toLowerCase()}');\n`;
    } 
} else {
    code += `var ${varName} = document.createElement('${element.tagName.toLowerCase()}');\n`;
}

} else {
    // Handle non-SVG elements
    code += `var ${varName} = document.createElement('${element.tagName.toLowerCase()}');\n`;
}

        // if the inner html of elements[i] includes 'gen_page_constructor()', ignore this element, don't put this element on any type of promise chain
        if (element.innerHTML.includes('gen_page_constructor()') && element.getElementsByTagName('*').length === 0) {
            return;
        }

    // simpler version of the above char escaping code with set attributeNS for xlink:href; also did not solve the xlink:href problem
    for (let j = 0; j < element.attributes.length; j++) {
        let attrName = element.attributes[j].name;
        let attrValue = element.attributes[j].value.replace(/\n/g, ' ').replace(/ +/g, ' ');

        // Escape special characters in the attribute value
        let escaped_attrValue = attrValue.replace(/[\u00A0-\u9999<>\&]/gim, function(i) {
            return '\\u' + ('0000' + i.charCodeAt(0).toString(16)).slice(-4);
        }).replace(/\n/g, '\\n').replace(/`/g, '\\`').replace(/"/g, '\\"').replace(/'/g, "\\'").replace(/\$/g, '\\$');

        // Check if the attribute is an xlink attribute
        if (attrName.startsWith('xlink:')) {
            // Set the xlink attribute using setAttributeNS
            let xlinkHref = attrName === 'xlink:href';
            code += `${varName}.setAttributeNS('http://www.w3.org/1999/xlink', '${xlinkHref ? 'href' : attrName}', "${escaped_attrValue}");\n`;
        } else if (attrName.startsWith('xmlns:xlink')) {

        } else if (attrName.startsWith('xmlns:svg')) {

        } else {
            // Set regular attributes using setAttribute
            code += `${varName}.setAttribute("${attrName}", "${escaped_attrValue}");\n`;
        }
    }

    if (element.innerHTML && element.getElementsByTagName('*').length === 0) {
        let inner_HTML = element.innerHTML;

        let escaped_inner_HTML = inner_HTML.replace(/[\u00A0-\u9999<>\&]/gim, function(i) {
            return '\\u' + ('0000' + i.charCodeAt(0).toString(16)).slice(-4);
        });
    
        if (escaped_inner_HTML.includes('\n')) {
            escaped_inner_HTML = escaped_inner_HTML.split('\n').join('\\n');
        }

        ['`', '"', "'", '$'].forEach(char => {
            if (escaped_inner_HTML.includes(char)) {
                escaped_inner_HTML = escaped_inner_HTML.replace(new RegExp(`\\${char}`, 'g'), `\\${char}`);          
            }
        });

        // if the element is a script, set the text property
        if (element.tagName.toLowerCase() === 'script') {
            code += `${varName}.text = "${escaped_inner_HTML}";\n`;
        } else {
            code += `${varName}.innerHTML = "${escaped_inner_HTML}";\n`;
        }
    }

    // If the element is a script with a src, create a promise to load it
    if (element.tagName.toLowerCase() === 'script' && element.src) {
        let parentVarName = 'document.head';
            if (element.parentElement) {
                let parentIndex = Array.prototype.indexOf.call(elements, element.parentElement);
                parentVarName = `el${parentIndex + 1}`;
            }
            code += `promiseChain = promiseChain.then(() => new Promise((resolve, reject) => {
            ${varName}.onload = resolve;
            ${varName}.onerror = reject;
            ${parentVarName}.appendChild(${varName});
        }));\n`;

    } else {
        // For non-script elements or inline scripts, append them to their parent
        let parentVarName = 'targetEl';//'document.body'; // Default parent
        if (element.parentElement) {
            let parentIndex = Array.prototype.indexOf.call(elements, element.parentElement);
            parentVarName = `el${parentIndex + 1}`;
        }
        code += `promiseChain = promiseChain.then(() => { ${parentVarName}.appendChild(${varName}); });\n`;
    }
}

// Start the recursive promise chain creation
elements.forEach((element, index) => {
    createPromiseChainForElement(element, `el${index + 1}`);
});

// After all elements have been created and appended
code += 'promiseChain = promiseChain.then(() => {\n';
code += '    // Call your functions that depend on DOMContentLoaded here\n';
code += '    mainHorizCaller(targetEl);\n';

code += '});\n';

    return code;
}

</script>
<script>

function overlayClose () {

        var constructorCode = gen_page_constructor();
        console.log('#2');
        console.log(constructorCode);
        var pageConstructor = new Function(constructorCode);
        // rest of your code

        // create a Blob with your code
        var blob = new Blob([constructorCode], { type: "text/javascript" });

        // create a URL for the Blob
        var url = URL.createObjectURL(blob);

        // create a download link and click it
        var a = document.createElement('a');
        a.href = url;
        a.download = 'constructorCode.js';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

}

      var infowindow_content;
      let formclone;
      let form;

      var isNewVineyardOverlay = false;
      var isNewWineryOverlay = false;

      var wine_tasting = {};
      // var mapOverlays = new Array();
      var vineyard_mapOverlays = new Array();
      var winery_mapOverlays = new Array();
      // var mapInfowindows = new Array();
      var vineyard_mapInfowindows = new Array();
      var winery_mapInfowindows = new Array();

      //declare map

      var map;

      var mapStorageId;

      var pos = { lat: 39.868546, lng: -8.051975 };

    // declare directions vars
    var markerOriginDraw;
    var markerDestinationDraw;
    var placeOriginLoc;
    var placeDestinationLoc;
    var placeSourceLoc;
    var markerSourceDraw;

    var directionsRenderer;
    var lastResult = null;
    var MarkersList = [];
    // var MarkersDict = {};
    var DirectionsDict = {};
    var lastRenderer = null;

    var SourcesDict = {};

    var infowindowIndex = null;
    var areasDictKey = null;

    var AreasDict = {};
    var lastAreaRenderer = null;

      //set the drawing managers
      // var drawingManager;
      var vineyard_drawingManager;
      var winery_drawingManager;

      function trace(message) {
        if (typeof console != "undefined") {
          console.log(message);
        }
      }

//Function that gets run when the document loads
function mapInitialize() {

  var directionsService = new google.maps.DirectionsService();
// alowing users to drag the route
directionsRenderer = new google.maps.DirectionsRenderer({draggable: true});
directionsRenderer.setMap(map); // assuming 'map' is your Google Map instance

// event listener for when the user has finished dragging the route
google.maps.event.addListener(directionsRenderer, 'directions_changed', function() {
  // update the last result
  lastResult = directionsRenderer.getDirections();
  
});

    // // Try HTML5 geolocation.
    // if (navigator.geolocation) {
    //   navigator.geolocation.getCurrentPosition(
    //     (position) => {
    //       pos = {
    //         lat: position.coords.latitude,
    //         lng: position.coords.longitude,
    //       };
    //       map.setCenter(pos);
    //     },
    //     () => {
    //       handleLocationError(true);
    //     },
    //   );
    // } else {
    //   // Browser doesn't support Geolocation
    //   handleLocationError(false);
    // }



  var myOptions = {
    zoom: 12,
    center: pos,
    // disableDefaultUI: true,
    // drawingControl: false, // Disable default control
    // controlSize: 20,
    mapTypeId: "satellite",
    mapTypeControl: true, //enable/disable the map type control
    mapTypeControlOptions: {
      // controlSize: 20,
      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
      position: google.maps.ControlPosition.RIGHT_TOP,
    },
    panControl: false, // full screen enabler
    zoomControl: true,
    zoomControlOptions: {
      // style: google.maps.ZoomControlStyle.SMALL,
      position: google.maps.ControlPosition.RIGTH_BOTTOM,
    },
    streetViewControl: false,
  };

  map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

  //add the drawing tool that allows users to draw the vineyard plots on the map

  vineyard_drawingManager = new google.maps.drawing.DrawingManager({
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_LEFT,
      drawingModes: [google.maps.drawing.OverlayType.POLYGON],
    },
    polygonOptions: {
      editable: true,
      draggable: true,
      strokeColor: "#f7f701",
      strokeWeight: 3,
      fillColor: "#f7f701",
      fillOpacity: 0.45,
    }, // polygons created are editable by default
    // drawingControl: true,
  });
  //add the tools to the map

  vineyard_drawingManager.setMap(map);
  // Add your custom control to the map
  // map.controls[google.maps.ControlPosition.TOP_LEFT].push(document.getElementById('drawingControlContainer'));

  // add the drawing tool that allows users to draw the winery sites on the map
  winery_drawingManager = new google.maps.drawing.DrawingManager({
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_LEFT,
      drawingModes: [google.maps.drawing.OverlayType.POLYGON],
    },
    polygonOptions: {
      editable: true,
      draggable: true,
      strokeColor: "#38c4f2",
      strokeWeight: 3,
      fillColor: "#38c4f2",
      fillOpacity: 0.45,
    }, // polygons created are editable by default
  });

  //add the tools to the map
  winery_drawingManager.setMap(map);



// direction service & drawing mangers
directionsRenderer.setMap(map);

markerDestinationDraw = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.MARKER,
    drawingControl: true,
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_CENTER,
      drawingModes: ['marker']
    },
    // markerOptions: {
    //   icon: './img/Destination.png'
    // }
  });
  markerDestinationDraw.setMap(map);
  markerDestinationDraw.setDrawingMode(null);

  markerOriginDraw = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.MARKER,
    drawingControl: true,
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_CENTER,
      drawingModes: ['marker']
    },
    // markerOptions: {
    //   icon: './img/Origin.png'
    // }
  });
  markerOriginDraw.setMap(map);
  markerOriginDraw.setDrawingMode(null);
  google.maps.event.addListener(markerOriginDraw, 'markercomplete', function(marker) {
    placeOriginLoc = marker.getPosition();
    markerOriginDraw.setDrawingMode(null);
    MarkersList.push(marker);
    markerDestinationDraw.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
    google.maps.event.addListener(markerOriginDraw, 'click', function() {
        event.preventDefault();
      marker.setMap(null);
      placeOriginLoc = marker.getPosition();
    });
    
  });

    google.maps.event.addListener(markerDestinationDraw, 'markercomplete', function(marker) {
        placeDestinationLoc = marker.getPosition();
        MarkersList.push(marker);
        calcRoute(directionsService, directionsRenderer);
        markerOriginDraw.setDrawingMode(null);//google.maps.drawing.OverlayType.MARKER);
        markerDestinationDraw.setDrawingMode(null);

        
        google.maps.event.addListener(markerDestinationDraw, 'click', function() {
        marker.setMap(null);

        placeDestinationLoc = marker.getPosition();
        calcRoute(directionsService, directionsRenderer);
        });
    });



    // create the drawing manager for the areas polygon drawing
    var areaDraw = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.POLYGON,
        drawingControl: true,
        drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ['polygon']
        },
        polygonOptions: {
            editable: true,
            draggable: true,
            strokeColor: "#b30b00",
            strokeWeight: 3,
            fillColor: "#b30b00",
            fillOpacity: 0.45,
        }
    });
    areaDraw.setMap(map);
    areaDraw.setDrawingMode(null);

    google.maps.event.addListener(areaDraw, 'polygoncomplete', function(polygon) {

      // check if the overlay is a plygon, i.e. if it has more tha 3 vertices

      if (polygon.getPath().getLength() > 2) {
        // click the button with id="areaEnd"
        document.getElementById("areaEnd").click();

        const infowindowType = areasDictKey.includes('vineyard') ? 'vineyard' : 'winery';
        const outerPolygon = window[infowindowType + "_mapOverlays"][infowindowIndex];

        const outerArea = pathArea(outerPolygon.getPath()) / 10000;
        const innerArea = pathArea(polygon.getPath()) / 10000;
        const percentArea = innerArea / outerArea * 100;

        document.getElementById("areaAbsolute").value = innerArea.toFixed(2);
        document.getElementById("areaPercent").value = percentArea.toFixed(2);

        AreasDict[areasDictKey] = {polygon, area: innerArea, percent: percentArea};
        polygon.setMap(map);
        // google.maps.event.addListener(polygon, 'click', function() {
        //     polygon.setMap(null);
        //     delete AreasDict[polygon.id];
        // });

        // enable the submit button with id="areaSubmit"
        document.getElementById("areaSubmit").disabled = false;

      } else {
        // remove the polygon if it has less than 3 vertices
        polygon.setMap(null);
        alert("Please draw a polygon with at least 3 vertices.");
        // polygon.remove();
        // click the button with id="areaStart"
        document.getElementById("areaStart").click();
      }

    });

    // add an event listener to the areaDraw poligons for user editing
    google.maps.event.addListener(areaDraw, 'overlaycomplete', function(event) {
        if (event.type === 'polygon') {
            google.maps.event.addListener(event.overlay.getPath(), 'set_at', function() {
                const infowindowType = areasDictKey.includes('vineyard') ? 'vineyard' : 'winery';
                const outerPolygon = window[infowindowType + "_mapOverlays"][infowindowIndex];

                const outerArea = pathArea(outerPolygon.getPath()) / 10000;
                const innerArea = pathArea(event.overlay.getPath()) / 10000;
                const percentArea = innerArea / outerArea * 100;

                document.getElementById("areaAbsolute").value = innerArea.toFixed(2);
                document.getElementById("areaPercent").value = percentArea.toFixed(2);

                AreasDict[areasDictKey] = {polygon: event.overlay, area: innerArea, percent: percentArea};
            });
            google.maps.event.addListener(event.overlay.getPath(), 'insert_at', function() {
                const infowindowType = areasDictKey.includes('vineyard') ? 'vineyard' : 'winery';
                const outerPolygon = window[infowindowType + "_mapOverlays"][infowindowIndex];

                const outerArea = pathArea(outerPolygon.getPath()) / 10000;
                const innerArea = pathArea(event.overlay.getPath()) / 10000;
                const percentArea = innerArea / outerArea * 100;

                document.getElementById("areaAbsolute").value = innerArea.toFixed(2);
                document.getElementById("areaPercent").value = percentArea.toFixed(2);

                AreasDict[areasDictKey] = {polygon: event.overlay, area: innerArea, percent: percentArea};
            });
        }
    });
   
 
    // set a drawing manager for destination markers
    markerSourceDraw = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.MARKER,
        drawingControl: true,
        drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ['marker']
        }
        // ,
        // markerOptions: {
        //     icon: './img/Destination.png'
        // }
    });
    markerSourceDraw.setMap(map);
    markerSourceDraw.setDrawingMode(null);

    google.maps.event.addListener(markerSourceDraw, 'markercomplete', function(marker) {
      // get the lat and lng of the marker
        placeSourceLoc = marker.getPosition();
        MarkersList.push(marker);
        markerOriginDraw.setDrawingMode(null);//google.maps.drawing.OverlayType.MARKER);
        markerSourceDraw.setDrawingMode(null);

        // set the value of the input field with id="source_search" to the lat and lng of the marker
        document.getElementById("source_search").value = placeSourceLoc;//placeSourceLoc.lat() + ", " + placeSourceLoc.lng();

        // enable the submit button with id="sourceSubmit"
        document.getElementById("sourceSubmit").disabled = false;

        // add the marker to the MarkersList
        SourcesDict[areasDictKey] = {marker, location: placeSourceLoc};


        // enable the submit button with id="sourceSubmit"
        document.getElementById("sourceSubmit").disabled = false;

        // // add an event listener to the marker to remove it when clicked
        // google.maps.event.addListener(markerSourceDraw, 'click', function() {
        //     // marker.setMap(null);
        //     placeSourceLoc = marker.getPosition();

        // });
    });



  google.maps.event.addListenerOnce(map, "tilesloaded", function () {
    setTimeout(function () {
      console.log("Hello, map is loaded!");
      // do something only the first time the map is loaded

      function moveDrawControls(drawingTools) {
        // move drawing tools to the div with id="vineyard_drawingControlContainer"

        console.log("######### 1 #########");
        console.log(drawingTools);

        let vineyardStart_Button =
          drawingTools[0].children[1].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        vineyardStart_Button.id = "vineyardStart_Button";
        // remove the style box-shadow attribute from the vineyardStart_Button
        vineyardStart_Button.style.boxShadow = "none";
        // move the vineyardStart_Button to the div with id="vineyardStart_Button_container"
        document
          .getElementById("vineyardStart_Button_container")
          .appendChild(vineyardStart_Button);
// add an event listener to the vineyardStart_Button 
        vineyardStart_Button.addEventListener("click", function () {
          winery_drawingManager.setDrawingMode(null);
          markerOriginDraw.setDrawingMode(null);
          markerDestinationDraw.setDrawingMode(null);
        });


        let vineyardStop_Button =
          drawingTools[0].children[0].getElementsByTagName("button")[0];
        // set an id attribute to the second button element
        vineyardStop_Button.id = "vineyardStop_Button";
        // remove the style box-shadow attribute from the vineyardStop_Button
        vineyardStop_Button.style.boxShadow = "none";
        // move the vineyardStop_Button to the div with id="vineyardStop_Button_container"
        document
          .getElementById("vineyardStop_Button_container")
          .appendChild(vineyardStop_Button);

          // add an event listener to the vineyardStop_Button
          vineyardStop_Button.addEventListener("click", function () {
            markerOriginDraw.setDrawingMode(null);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
          });

        let wineryStart_Button =
          drawingTools[1].children[1].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        wineryStart_Button.id = "wineryStart_Button";
        // remove the style box-shadow attribute from the wineryStart_Button
        wineryStart_Button.style.boxShadow = "none";
        // move the wineryStart_Button to the div with id="wineryStart_Button_container"
        document
          .getElementById("wineryStart_Button_container")
          .appendChild(wineryStart_Button);

          // add an event listener to the wineryStart_Button
          wineryStart_Button.addEventListener("click", function () {
vineyard_drawingManager.setDrawingMode(null);
markerOriginDraw.setDrawingMode(null);
markerDestinationDraw.setDrawingMode(null);
areaDraw.setDrawingMode(null);
          });

        let wineryStop_Button =
          drawingTools[1].children[0].getElementsByTagName("button")[0];
        // set an id attribute to the second button element
        wineryStop_Button.id = "wineryStop_Button";
        // remove the style box-shadow attribute from the wineryStop_Button
        wineryStop_Button.style.boxShadow = "none";
        // move the wineryStop_Button to the div with id="wineryStop_Button_container"
        document
          .getElementById("wineryStop_Button_container")
          .appendChild(wineryStop_Button);

        // add an event listener to the wineryStop_Button
        wineryStop_Button.addEventListener("click", function () {
          markerOriginDraw.setDrawingMode(null);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
            areaDraw.setDrawingMode(null);
        });

console.log("################# 3 #################");
console.log(drawingTools[2].children[1].getElementsByTagName("button")[0]);
let originMarkerStart = drawingTools[3].children[1].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        originMarkerStart.id = "originMarkerStart";
        // remove the style box-shadow attribute from the originMarker
        originMarkerStart.style.boxShadow = "none";
        // move the originMarker to the div with id="originMarker_container"
        document
          .getElementById("originMarker_container")
          .appendChild(originMarkerStart);

          // add an event listener to the originMarker
          originMarkerStart.addEventListener("click", function () {
            markerOriginDraw.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
            areaDraw.setDrawingMode(null);

          });
let originMarkerEnd = drawingTools[3].children[0].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        originMarkerEnd.id = "originMarkerEnd";
        // remove the style box-shadow attribute from the originMarker
        originMarkerEnd.style.boxShadow = "none";
        // move the originMarker to the div with id="originMarker_container"
        document
          .getElementById("originMarker_container")
          .appendChild(originMarkerEnd);

          // add an event listener to the originMarker
          originMarkerEnd.addEventListener("click", function () {
            markerOriginDraw.setDrawingMode(null);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
            areaDraw.setDrawingMode(null);

          });

let destinationMarkerStart = drawingTools[2].children[1].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        destinationMarkerStart.id = "destinationMarkerStart";
        // remove the style box-shadow attribute from the destinationMarker
        destinationMarkerStart.style.boxShadow = "none";
        // move the destinationMarker to the div with id="destinationMarker_container"
        document
          .getElementById("destinationMarker_container")
          .appendChild(destinationMarkerStart);

          // add an event listener to the destinationMarker
          destinationMarkerStart.addEventListener("click", function () {
            markerDestinationDraw.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
            markerOriginDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
            areaDraw.setDrawingMode(null);
          });

let destinationMarkerEnd = drawingTools[2].children[0].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        destinationMarkerEnd.id = "destinationMarkerEnd";
        // remove the style box-shadow attribute from the destinationMarker
        destinationMarkerEnd.style.boxShadow = "none";
        // move the destinationMarker to the div with id="destinationMarker_container"
        document
          .getElementById("destinationMarker_container")
          .appendChild(destinationMarkerEnd);

          // add an event listener to the destinationMarker
          destinationMarkerEnd.addEventListener("click", function () {
            markerOriginDraw.setDrawingMode(null);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
            areaDraw.setDrawingMode(null);
          });


let areaStart = drawingTools[4].children[1].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        areaStart.id = "areaStart";
        // remove the style box-shadow attribute from the areaStart
        areaStart.style.boxShadow = "none";
        // move the areaStart to the div with id="areaStart_container"          
        document
          .getElementById("areaStart_container")
          .appendChild(areaStart);

          // add an event listener to the areaStart
          areaStart.addEventListener("click", function () {
            areaDraw.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
            markerOriginDraw.setDrawingMode(null);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
          });

let areaEnd = drawingTools[4].children[0].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        areaEnd.id = "areaEnd";
        // remove the style box-shadow attribute from the areaEnd
        areaEnd.style.boxShadow = "none";
        // move the areaEnd to the div with id="areaEnd_container"
        document
          .getElementById("areaStart_container")
          .appendChild(areaEnd);

          // add an event listener to the areaEnd
          areaEnd.addEventListener("click", function () {
            areaDraw.setDrawingMode(null);
            markerOriginDraw.setDrawingMode(null);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
          });





        // let overlayCloseButton = drawingTools.children[3].getElementsByTagName("button")[3];
        // // set an id attribute to the first button element
        // overlayCloseButton.id = "overlayCloseButton";
        // // remove the style box-shadow attribute from the overlayCloseButton
        // overlayCloseButton.style.boxShadow = "none";
        // // move the overlayCloseButton to the div with id="overlayCloseButton_container"
        // document
        //   .getElementById("overlayCloseButton_container")
        //   .appendChild(overlayCloseButton);

        //   // add an event listener to the overlayCloseButton
        //   overlayCloseButton.addEventListener("click", function () {
        //     overlayClose();
        //   });

        let SourceStart = drawingTools[5].children[1].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        SourceStart.id = "SourceStart";
        // remove the style box-shadow attribute from the SourceStart
        SourceStart.style.boxShadow = "none";
        // move the SourceStart to the div with id="SourceMarker_container"
        document
          .getElementById("SourceMarker_container")
          .appendChild(SourceStart);

          // add an event listener to the SourceStart
          SourceStart.addEventListener("click", function () {
            markerSourceDraw.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
            markerOriginDraw.setDrawingMode(null);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
            areaDraw.setDrawingMode(null);
          });

        let SourceEnd = drawingTools[5].children[0].getElementsByTagName("button")[0];
        // set an id attribute to the first button element
        SourceEnd.id = "SourceEnd";
        // remove the style box-shadow attribute from the SourceEnd
        SourceEnd.style.boxShadow = "none";
        // move the SourceEnd to the div with id="SourceMarker_container"
        document
          .getElementById("SourceMarker_container")
          .appendChild(SourceEnd);

          // add an event listener to the SourceEnd
          SourceEnd.addEventListener("click", function () {
            markerSourceDraw.setDrawingMode(null);
            markerOriginDraw.setDrawingMode(null);
            markerDestinationDraw.setDrawingMode(null);
            vineyard_drawingManager.setDrawingMode(null);
            winery_drawingManager.setDrawingMode(null);
            areaDraw.setDrawingMode(null);
          });
      }

      // select the target node
      var target = document.getElementById("map_canvas");

      // create an observer instance
      var observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          //  get the parent element of '''<div class="gmnoprint" role="menubar" style="margin: 5px; z-index: 10; position: absolute; left: 0px; top: 0px;">'
          var polDrawing = document.getElementsByClassName("gmnoprint");


          // var drawingTools = [];
          // iterate polDrawing to find the element that contains the drawing tools, i.e. has z-index: 10
          // for (var i = 0; i < polDrawing.length; i++) {
          //   // console.log(polDrawing[i].style.zIndex);
            
          //   if (polDrawing[i].style.zIndex == 10) {
          //    drawingTools.push(polDrawing[i].parentElement);
          //     // drawingTools = polDrawing[i].parentElement;

          //     // break;
          //   }
          // }

          // filter out the elements that contains the drawing tools, i.e. has z-index: 10
          var drawingTools = Array.from(polDrawing).filter((element) => element.style.zIndex == 10);
          console.log("######### 0 #########");
          console.log(polDrawing);
          console.log(polDrawing.length);


          console.log("######### 1 #########");
          console.log(drawingTools);
          console.log(drawingTools.length);
          console.log(drawingTools.length);
          console.log(drawingTools[3].children[1].getElementsByTagName("button"));
          // console.log('iuguigigu', drawingTools[drawingTools.length - 1].children.getElementsByTagName("button")[1]);

          

          if (drawingTools[4].children[1].getElementsByTagName("button")) {
            observer.disconnect();
            console.log("observer disconnected");
            moveDrawControls(drawingTools);
          } else {
            // console.log('Buttons not found');
          }
        });
      });

      // configuration of the observer:
      var config = {
        attributes: true,
        childList: true,
        characterData: true,
        subtree: true,
      };

      // pass in the target node, as well as the observer options
      observer.observe(target, config);
    }, 10);
  });

  // Add a listener for the 'overlaycomplete' event
  google.maps.event.addListener(
    vineyard_drawingManager,
    "overlaycomplete",
    function (dzenho) {
      dzenho.overlay.type = dzenho.type;
      vineyard_mapOverlays.push(dzenho.overlay);

      // hide map controls
      map.set("zoomControl", false);
      map.set("mapTypeControl", false);
      map.set("panControl", false);

      // hide the main container
      document.getElementById("toggle_box").style.display = "none";

      // Switch back to non-drawing mode after drawing a shape.
      vineyard_drawingManager.setDrawingMode(null);
      winery_drawingManager.setDrawingMode(null);
      
      var w = window.screen.width;//window.outerWidth;//.innerWidth;
      var h = window.screen.height;//window.outerHeight;//.innerHeight;
      console.log("######## 2 #########");
      console.log("w", w, "h", h);
      //---------------

      if (dzenho.overlay.strokeColor == "#f7f701") {
        $(".prod_areas").addClass("hidesudo");
        $(".acessos").addClass("showsudo");

        // Clone the main form
        var form = $("#vineyard_main_form").clone().show();
        // update the id of the "targetEl" div in the cloned form
        form[0].getElementsByClassName(
          "targetEl"
        )[0].id = `targetEl${vineyard_mapInfowindows.length}`;

        var infowindow_content = form[0];

        var infowindow = new google.maps.InfoWindow({
          content: infowindow_content,
          maxWidth: w,
          // position: google.maps.ControlPosition.TOP_LEFT,
          position: dzenho.overlay
            .getPath()
            .getAt(Math.round(dzenho.overlay.getPath().getLength() / 3)),
        });

        // Set the isNewVineyardOverlay flag
        isNewVineyardOverlay = true;

        infowindow.open(map, dzenho.overlay);
        vineyard_mapInfowindows.push(infowindow);
        

        var delInfoWindow = infowindow.content.querySelector("#apagar");
        delInfoWindow.addEventListener("click", function () {
          // form.submit({ dzenho: dzenho }, function (event) {
          $(".prod_areas").removeClass("hidesudo");
          $(".acessos").removeClass("showsudo");
          //prevent the default form behavior (which would refresh the page) . aqui pode ser a solução para popular todo o formlário se for usar o processo antigo.

          event.preventDefault();

          // show map controls
          map.set("zoomControl", true);
          map.set("mapTypeControl", true);
          map.set("panControl", true);

          // show the main container
          document.getElementById("toggle_box").style.display = "block";

          // Close the InfoWindow
          infowindow.close();

          // Delete the InfoWindow
          infowindow = null;

          // Remove the overlay from the map
          dzenho.overlay.setMap(null);

          // Delete the overlay
          overlay = null;

          // then, remove the overlay from the array
          var index = vineyard_mapOverlays.indexOf(dzenho.overlay);
          vineyard_mapOverlays.splice(index, 1);
          // then, remove the overlay from the map
          dzenho.overlay.setMap(null);
          // then, remove the infowindows name from the array
          // var index = vineyard_mapInfowindows.indexOf(infowindow);
          vineyard_mapInfowindows.splice(index, 1);

          // Delete the form from the DOM
          form.remove();

          // get <ol> element with id="vineyard_list"
          var ol = document.getElementById("vineyard_list");

          // remove the child of the <ol> element with the index of the overlay in ol.children
          ol.removeChild(ol.children[index]);

          // regext to find if the innerhtml of the <li> element is 'Plot' followed by one or more digits
          var re = /Plot \d+/;

          for (i = 0; i < vineyard_mapInfowindows.length; i++) {
            const init_targetEl =
              vineyard_mapInfowindows[i].content.querySelector(".targetEl").id;
              
            vineyard_mapInfowindows[i].content.querySelector(
              ".targetEl"
            ).id = `targetEl${i}`;
            
            // if ol.children[i] innerHTML is 'Plot' followed by one or more digits
            if (re.test(ol.children[i].innerHTML)) {
              // set the innerHTML of the <li> element to 'Plot' followed by the index of the overlay in vineyard_mapInfowindows
              ol.children[i].innerHTML = `Plot ${i}`;
            }

            // update the ids of the <li> elements
            ol.children[i].id = `plot_${i}`;
          }
        });

        var closeInfoWindow = infowindow.content.querySelector("#aceitar");
        closeInfoWindow.addEventListener("click", function () {
          google.maps.event.trigger(infowindow, "closeclick");
        });

        // Add a listener for the 'domready' event
        google.maps.event.addListener(infowindow, "domready", function () {
          // I need to figure out a way to see if a new infowindow was created, or if the user just clicked on any already drawn plot
          if (!isNewVineyardOverlay) {
            return;
          }

          if (dzenho.overlay.strokeColor == "#f7f701") {
            // get the index of the dzenho.overlay in the vineyard_mapOverlays array
            var caller = vineyard_mapOverlays.indexOf(dzenho.overlay);

            // Now the content is loaded in the DOM, and you can access it
            // var targetEl = document.getElementById('targetEl');
            // firstPlotFlag = true;
            // Fetch and execute the JavaScript code from 'constructorCode.js'
            fetch("./vineyard/js/vineyard_constructorCode.js")
              .then((response) => response.text())
              .then((data) => {
                var targetEl = document.getElementById(
                  `targetEl${vineyard_mapInfowindows.length - 1}`
                ); // Make sure this is the correct element
                console.log("########## 3 ##########");
                console.log(`targetEl${vineyard_mapInfowindows.length - 1}`);
                console.log(
                  document.getElementById(
                    `targetEl${vineyard_mapInfowindows.length - 1}`
                  )
                );
                // Encapsulate your constructorCode in an immediately invoked function expression (IIFE) to create a new scope for each execution
                data = `(function(targetEl) { ${data} })(document.getElementById("targetEl${
                  vineyard_mapInfowindows.length - 1
                }"));`;
                // console.log(data);
                // generating new function Name
                fName = `targetEl${vineyard_mapInfowindows.length - 1}`;

                // if(window[fName] === undefined){
                //   console.log('fName: is not var')
                //       window[fName] = new GraphCreator(caller);
                // }
                // Create a new Function object with the code as its body and call it
                var result = new Function(fName, data);
                console.log("################## 4 ####################");
                console.log(result);
                try {
                  result(targetEl);
                } catch (error) {
                  console.error("Error:", error);
                }
                // result(targetEl);

                var new_liEl = document.createElement("li");
                // Set the list item id
                new_liEl.id = `plot_${vineyard_mapInfowindows.length - 1}`;
                // change the mouse cursor to a pointer when hovering over the list item
                new_liEl.style.cursor = "pointer";
                // set the mouseover event to highlight the corresponding overlay, border color and border width
                new_liEl.setAttribute(
                  "onmouseover",
                  `vineyard_mapOverlays[this.id.split('_')[1]].setOptions({fillColor: '#15ff00', strokeColor: '#15ff00', strokeWeight: 6});`
                );
                // set the mouseout event to remove the highlight from the corresponding overlay
                new_liEl.setAttribute(
                  "onmouseout",
                  `vineyard_mapOverlays[this.id.split('_')[1]].setOptions({fillColor: '#f7f701', strokeColor: '#f7f701', strokeWeight: 3});`
                );

                // set attrib onselectstart="return false"
                new_liEl.setAttribute("onselectstart", "return false");

                new_liEl.setAttribute(
                  "onclick",
                  "triggerInfowindow(this.id.split('_')[1],vineyard_mapOverlays, vineyard_mapInfowindows);"
                );
                // trigger the event on click google.maps.event.addListener(dzenho.overlay, "click", function () { with vineyard_mapOverlays[this.id.split('_')[1]]

                // Set the list item text
                new_liEl.innerHTML = `Plot ${vineyard_mapInfowindows.length}`;
                // Append the list item to the list
                document.getElementById("vineyard_list").appendChild(new_liEl);
              })
              .catch((error) => console.error("Error:", error));
          }
        });
      }
      //______________---X button
      google.maps.event.addListener(infowindow, "closeclick", function () {
        $(".prod_areas").removeClass("hidesudo");
        $(".acessos").removeClass("showsudo");

        //
        // get the closest calss="targetEl" element to 'element'
        var targetElnr = infowindow.content
          .querySelector("#vineyard_context_plotName")
          .closest(".targetEl")
          .id.split("targetEl")[1];
        // get the <ol> for the specific type
        var ol = document.getElementById("vineyard_list");

        var listItem = ol.children[targetElnr];
        // get the text of the element with id "vineyard_context_plotName"
        var text = infowindow.content.querySelector(
          "#vineyard_context_plotName"
        ).value;

        if (text != "") {
          // set the text of the list item to the text of the element with id "vineyard_context_plotName"
          listItem.innerHTML = text;
        } else {
          listItem.innerHTML = `Plot ${targetElnr}`;
        }

        // show map controls

        map.set("zoomControl", true);
        map.set("mapTypeControl", true);
        map.set("panControl", true);

        // show the main container
        document.getElementById("toggle_box").style.display = "block";

        for (i = 0; i < vineyard_mapInfowindows.length; i++) {
          vineyard_mapInfowindows[i].close();
          
        }
        // infowindow_content = "";
        map.setCenter(infowindow.position);
      });

      // google.maps.event.addListener(infowindow, "click", function () {
      //   console.log(event.target.id);
      //   debugger;
      // });

      //-----------------make each shape clickable

      google.maps.event.addListener(dzenho.overlay, "click", function () {
        isNewVineyardOverlay = false;
        event.preventDefault();

        // hide map controls
        map.set("zoomControl", false);
        map.set("mapTypeControl", false);
        map.set("panControl", false);

        // hide the main container
        document.getElementById("toggle_box").style.display = "none";

        vineyard_drawingManager.setDrawingMode(null);
        winery_drawingManager.setDrawingMode(null);

        // ---------------
        if (dzenho.overlay.strokeColor == "#f7f701") {
          
          infowindow.open(map, dzenho.overlay);

          $(".prod_areas").addClass("hidesudo");
          $(".acessos").addClass("showsudo");
        }
      });

      // /*
      //  * O evento google.maps.event.addListener() espera pela
      //  * criação da estrutura HTML da infowindow 'domready'
      //  * e antes da abertura da infowindow serão aplicados
      //  * os estilos definidos
      //  */
      // google.maps.event.addListener(infowindow, "domready", function () {
      //   // Referência ao DIV que recebe o conteúdo da infowindow recorrendo ao jQuery
      //   var iwOuter = $(".gm-style-iw");

      //   /* Uma vez que o div pretendido está numa posição anterior ao div .gm-style-iw.
      //    * Recorremos ao jQuery e criamos uma variável iwBackground,
      //    * e aproveitamos a referência já existente do .gm-style-iw para obter o div anterior com .prev().
      //    */
      //   var iwBackground = iwOuter.prev();

      //   // Remover o div da sombra do fundo
      //   iwBackground.children(":nth-child(2)").css({ display: "none" });

      //   // Remover o div de fundo branco
      //   iwBackground.children(":nth-child(4)").css({ display: "none" });
      // });
    }
  );

  google.maps.event.addListener(
  winery_drawingManager,
  "overlaycomplete",
  function (dzenho) {
    dzenho.overlay.type = dzenho.type;
    winery_mapOverlays.push(dzenho.overlay);

    // hide map controls
    map.set("zoomControl", false);
    map.set("mapTypeControl", false);
    map.set("panControl", false);

    // hide the main container
    document.getElementById("toggle_box").style.display = "none";

    // Switch back to non-drawing mode after drawing a shape.
    vineyard_drawingManager.setDrawingMode(null);
    winery_drawingManager.setDrawingMode(null);

    var w = window.innerWidth * (1747 / 1920);//window.screen.width;//window.outerWidth;//.innerWidth;
      var h = window.innerHeight * (753 / 919);//window.screen.height;//window.outerHeight;//.innerHeight;
    console.log("######## 2 #########");
    console.log("w", w, "h", h);
    //---------------

    if (dzenho.overlay.strokeColor == "#38c4f2") {
      $(".prod_areas").addClass("hidesudo");
      $(".acessos").addClass("showsudo");

      // Clone the main form
      var form = $("#vineyard_main_form").clone().show();
      // update the id of the "targetEl" div in the cloned form
      form[0].getElementsByClassName(
        "targetEl"
      )[0].id = `targetEl${winery_mapInfowindows.length}`;

      var infowindow_content = form[0];

      var infowindow = new google.maps.InfoWindow({
        content: infowindow_content,
        maxWidth: w,
        // position: google.maps.ControlPosition.TOP_LEFT,
        position: dzenho.overlay
          .getPath()
          .getAt(Math.round(dzenho.overlay.getPath().getLength() / 3)),
      });

      // Set the isNewWineryOverlay flag
      isNewWineryOverlay = true;

      infowindow.open(map, dzenho.overlay);
      winery_mapInfowindows.push(infowindow);

      var delInfoWindow = infowindow.content.querySelector("#apagar");
      delInfoWindow.addEventListener("click", function () {
        // form.submit({ dzenho: dzenho }, function (event) {
        $(".prod_areas").removeClass("hidesudo");
        $(".acessos").removeClass("showsudo");
        //prevent the default form behavior (which would refresh the page) . aqui pode ser a solução para popular todo o formlário se for usar o processo antigo.

        event.preventDefault();

        // show map controls
        map.set("zoomControl", true);
        map.set("mapTypeControl", true);
        map.set("panControl", true);

        // show the main container
        document.getElementById("toggle_box").style.display = "block";

        // Close the InfoWindow
        infowindow.close();

        // Delete the InfoWindow
        infowindow = null;

        // Remove the overlay from the map
        dzenho.overlay.setMap(null);

        // Delete the overlay
        overlay = null;

        // then, remove the overlay from the array
        var index = winery_mapOverlays.indexOf(dzenho.overlay);
        winery_mapOverlays.splice(index, 1);
        // then, remove the overlay from the map
        dzenho.overlay.setMap(null);
        // then, remove the infowindows name from the array
        // var index = winery_mapInfowindows.indexOf(infowindow);
        winery_mapInfowindows.splice(index, 1);

        // Delete the form from the DOM
        form.remove();

        // get <ol> element with id="winery_list"
        var ol = document.getElementById("winery_list");

        // remove the child of the <ol> element with the index of the overlay in ol.children
        ol.removeChild(ol.children[index]);

        // regext to find if the innerhtml of the <li> element is 'Winery' followed by one or more digits
        var re = /Winery \d+/;

        for (i = 0; i < winery_mapInfowindows.length; i++) {
          const init_targetEl =
            winery_mapInfowindows[i].content.querySelector(".targetEl").id;
            
          winery_mapInfowindows[i].content.querySelector(
            ".targetEl"
          ).id = `targetEl${i}`;
          // alert("from: " + init_targetEl + "to :" + winery_mapInfowindows[i].content.querySelector('.targetEl').id);

          // if ol.children[i] innerHTML is 'Winery' followed by one or more digits
          if (re.test(ol.children[i].innerHTML)) {
            // set the innerHTML of the <li> element to 'Winery' followed by the index of the overlay in winery_mapInfowindows
            ol.children[i].innerHTML = `Winery ${i}`;
          }

          // update the ids of the <li> elements
          ol.children[i].id = `winery_${i}`;
        }
      });

      var closeInfoWindow = infowindow.content.querySelector("#aceitar");
      closeInfoWindow.addEventListener("click", function () {
        google.maps.event.trigger(infowindow, "closeclick");
      });

      // Add a listener for the 'domready' event
      google.maps.event.addListener(infowindow, "domready", function () {
        // I need to figure out a way to see if a new infowindow was created, or if the user just clicked on any already drawn Winery
        if (!isNewWineryOverlay) {
          return;
        }

        if (dzenho.overlay.strokeColor == "#38c4f2") {
          // get the index of the dzenho.overlay in the winery_mapOverlays array
          var caller = winery_mapOverlays.indexOf(dzenho.overlay);

          // Now the content is loaded in the DOM, and you can access it
          // var targetEl = document.getElementById('targetEl');
          // firstWineryFlag = true;
          // Fetch and execute the JavaScript code from 'constructorCode.js'
          fetch("./winery/js/winery_constructorCode.js")
            .then((response) => response.text())
            .then((data) => {
              data = data.replace(/\\u00ce\\u201d/g, 'Δ');
              var targetEl = document.getElementById(
                `targetEl${winery_mapInfowindows.length - 1}`
              ); // Make sure this is the correct element
              console.log("########## 3 ##########");
              console.log(`targetEl${winery_mapInfowindows.length - 1}`);
              console.log(
                document.getElementById(
                  `targetEl${winery_mapInfowindows.length - 1}`
                )
              );
              // Encapsulate your constructorCode in an immediately invoked function expression (IIFE) to create a new scope for each execution
              data = `(function(targetEl) { ${data} })(document.getElementById("targetEl${
                winery_mapInfowindows.length - 1
              }"));`;
              // console.log(data);
              // generating new function Name
              fName = `targetEl${winery_mapInfowindows.length - 1}`;

              // if(window[fName] === undefined){
              //   console.log('fName: is not var')
              //       window[fName] = new GraphCreator(caller);
              // }
              // Create a new Function object with the code as its body and call it
              var result = new Function(fName, data);
              console.log("################## 4 ####################");
              console.log(result);
              try {
                result(targetEl);
              } catch (error) {
                console.error("Error:", error);
              }
              // result(targetEl);

              var new_liEl = document.createElement("li");
              // Set the list item id
              new_liEl.id = `Winery_${winery_mapInfowindows.length - 1}`;
              // change the mouse cursor to a pointer when hovering over the list item
              new_liEl.style.cursor = "pointer";
              // set the mouseover event to highlight the corresponding overlay, border color and border width
              new_liEl.setAttribute(
                "onmouseover",
                `winery_mapOverlays[this.id.split('_')[1]].setOptions({fillColor: '#f7a71b', strokeColor: '#f7a71b', strokeWeight: 6});`
              );
              // set the mouseout event to remove the highlight from the corresponding overlay
              new_liEl.setAttribute(
                "onmouseout",
                `winery_mapOverlays[this.id.split('_')[1]].setOptions({fillColor: '#38c4f2', strokeColor: '#38c4f2', strokeWeight: 3});`
              );

              // set attrib onselectstart="return false"
              new_liEl.setAttribute("onselectstart", "return false");

              new_liEl.setAttribute(
                "onclick",
                "triggerInfowindow(this.id.split('_')[1],winery_mapOverlays,winery_mapInfowindows);"
              );
              // trigger the event on click google.maps.event.addListener(dzenho.overlay, "click", function () { with winery_mapOverlays[this.id.split('_')[1]]

              // Set the list item text
              new_liEl.innerHTML = `Winery ${winery_mapInfowindows.length}`;
              // Append the list item to the list
              document.getElementById("winery_list").appendChild(new_liEl);
              
            })
            .catch((error) => console.error("Error:", error));
        }
      });
    }
    //______________---X button
    google.maps.event.addListener(infowindow, "closeclick", function () {
      $(".prod_areas").removeClass("hidesudo");
      $(".acessos").removeClass("showsudo");

      //
      // get the closest calss="targetEl" element to 'element'
      var targetElnr = infowindow.content
        .querySelector("#winery_name")
        .closest(".targetEl")
        .id.split("targetEl")[1];
      // get the <ol> for the specific type
      var ol = document.getElementById("winery_list");

      var listItem = ol.children[targetElnr];
      // get the text of the element with id "winery_name"
      var text = infowindow.content.querySelector(
        "#winery_name"
      ).value;

      if (text != "") {
        // set the text of the list item to the text of the element with id "winery_name"
        listItem.innerHTML = text;
      } else {
        listItem.innerHTML = `Winery ${targetElnr}`;
      }

      // show map controls

      map.set("zoomControl", true);
      map.set("mapTypeControl", true);
      map.set("panControl", true);

      // show the main container
      document.getElementById("toggle_box").style.display = "block";

      for (i = 0; i < winery_mapInfowindows.length; i++) {
        winery_mapInfowindows[i].close();        
      }
      // infowindow_content = "";
      map.setCenter(infowindow.position);
    });

    google.maps.event.addListener(infowindow, "click", function () {
      console.log(event.target.id);
      debugger;
    });

    //-----------------make each shape clickable

    google.maps.event.addListener(dzenho.overlay, "click", function () {
      isNewWineryOverlay = false;
      event.preventDefault();

      // hide map controls
      map.set("zoomControl", false);
      map.set("mapTypeControl", false);
      map.set("panControl", false);

      // hide the main container
      document.getElementById("toggle_box").style.display = "none";

      vineyard_drawingManager.setDrawingMode(null);
      winery_drawingManager.setDrawingMode(null);

      // ---------------
      if (dzenho.overlay.strokeColor == "#38c4f2") {
        // alert("this infowindow index in the array is: " + winery_mapInfowindows.indexOf(infowindow));
        infowindow.open(map, dzenho.overlay);

        $(".prod_areas").addClass("hidesudo");
        $(".acessos").addClass("showsudo");
      }
    });

    // /*
    //  * O evento google.maps.event.addListener() espera pela
    //  * criação da estrutura HTML da infowindow 'domready'
    //  * e antes da abertura da infowindow serão aplicados
    //  * os estilos definidos
    //  */
    // google.maps.event.addListener(infowindow, "domready", function () {
    //   // Referência ao DIV que recebe o conteúdo da infowindow recorrendo ao jQuery
    //   var iwOuter = $(".gm-style-iw");

    //   /* Uma vez que o div pretendido está numa posição anterior ao div .gm-style-iw.
    //    * Recorremos ao jQuery e criamos uma variável iwBackground,
    //    * e aproveitamos a referência já existente do .gm-style-iw para obter o div anterior com .prev().
    //    */
    //   var iwBackground = iwOuter.prev();

    //   // Remover o div da sombra do fundo
    //   iwBackground.children(":nth-child(2)").css({ display: "none" });

    //   // Remover o div de fundo branco
    //   iwBackground.children(":nth-child(4)").css({ display: "none" });
    // });
  }
);


}





function triggerInfowindow(index, target, infwin) {
  // vineyard_mapInfowindows[index].open(map, vineyard_mapOverlays[index]);
  google.maps.event.trigger(target[index], "click");

  isNewWineryOverlay = false;
      event.preventDefault();

      // hide map controls
      map.set("zoomControl", false);
      map.set("mapTypeControl", false);
      map.set("panControl", false);

      // hide the main container
      document.getElementById("toggle_box").style.display = "none";

      vineyard_drawingManager.setDrawingMode(null);
      winery_drawingManager.setDrawingMode(null);

      // ---------------
      // if (target[index].strokeColor == "#38c4f2") {
        // alert("this infowindow index in the array is: " + winery_mapInfowindows.indexOf(infowindow));
        infwin[index].open(map, target[index]);

      //   $(".prod_areas").addClass("hidesudo");
      //   $(".acessos").addClass("showsudo");
      // }


}

function acessosfunc() {
        // show map controls

        map.set("zoomControl", true);

        // show drawing controls

        vineyard_drawingManager.setOptions({
          drawingMode: google.maps.drawing.OverlayType.POLYLINE,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_LEFT,
            drawingModes: [
              //google.maps.drawing.OverlayType.MARKER,

              //google.maps.drawing.OverlayType.POLYGON,

              google.maps.drawing.OverlayType.POLYLINE,
            ],
          },

          polylineOptions: {
            editable: true,

            strokeColor: "#FFFF00",

            strokeWeight: 3,
          }, // polylines created are editable by default
        });

        for (i = 0; i < vineyard_mapInfowindows.length; i++) {
          vineyard_mapInfowindows[i].close();
        }
      }

      this.isnumber = function (evt) {
        evt = evt ? evt : window.event;

        var charCode = evt.which ? evt.which : evt.keyCode;

        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
          return false;
        }

        return true;
      };

      function mapToDataObject() {
        for (var i = 0; i < mapOverlays.length; i++) {
          mapOverlays[i].prod_area = mapInfowindows[i].content.prod_area.value;
          mapOverlays[i].grape_vars =
            mapInfowindows[i].content.grape_vars.value;
          mapOverlays[i].justificacao =
            mapInfowindows[i].content.justificacao.value;
          mapOverlays[i].primavera = mapInfowindows[i].content.primavera.value;
          mapOverlays[i].verao = mapInfowindows[i].content.verao.value;
          mapOverlays[i].outono = mapInfowindows[i].content.outono.value;
          mapOverlays[i].inverno = mapInfowindows[i].content.inverno.value;
          mapOverlays[i].partmed = mapInfowindows[i].content.partmed.value;
          mapOverlays[i].partmax = mapInfowindows[i].content.partmax.value;
          mapOverlays[i].modalidade =
            mapInfowindows[i].content.modalidade.value;
          mapOverlays[i].moddiferentes =
            mapInfowindows[i].content.moddiferentes.value;
          mapOverlays[i].quais = mapInfowindows[i].content.quais.value;
          mapOverlays[i].proteccao = mapInfowindows[i].content.proteccao.value;
          mapOverlays[i].sugestoes = mapInfowindows[i].content.sugestoes.value;

          mapOverlays[i].transporte =
            mapInfowindows[i].content.transporte.value;
          mapOverlays[i].porqueacesso =
            mapInfowindows[i].content.porqueacesso.value;
          mapOverlays[i].sugestoesacesso =
            mapInfowindows[i].content.sugestoesacesso.value;
        }

        var tmpOverlay, paths;

        for (var i = 0; i < mapOverlays.length; i++) {
          if (mapOverlays[i].getMap() == null) {
            continue;
          }
          tmpOverlay = new Object();
          if (mapOverlays[i].type == "polygon") {
            tmpOverlay.paths = new Array();

            paths = mapOverlays[i].getPaths();

            for (var j = 0; j < paths.length; j++) {
              tmpOverlay.paths[j] = new Array();

              for (var k = 0; k < paths.getAt(j).length; k++) {
                tmpOverlay.paths[j][k] = {
                  lat: paths.getAt(j).getAt(k).lat().toString(),
                  lng: paths.getAt(j).getAt(k).lng().toString(),
                };
              }
              jQuery.ajax({
                url: "https://web.archive.org/web/20151009000557/https://docs.google.com/a/campus.fct.unl.pt/forms/d/1zqWMiZcv-ZpKjQcawmaV0S555ZLR8N80yl0Lk-43r4I/formResponse",
                data: {
                  "entry.1842183354": JSON.stringify(APIpage_autor.value),
                  "entry.1720390178": JSON.stringify(APIpage_entid.value),
                  "entry.1716839148": JSON.stringify(mapOverlays[i].type),
                  "entry.1697832013": JSON.stringify(tmpOverlay.paths),
                  "entry.1927026631": JSON.stringify(mapOverlays[i].prod_area),
                  "entry.631208417": JSON.stringify(mapOverlays[i].grape_vars),
                  "entry.1839150385": JSON.stringify(
                    mapOverlays[i].justificacao
                  ),
                  "entry.1208839541": JSON.stringify(mapOverlays[i].primavera),
                  "entry.1080778196": JSON.stringify(mapOverlays[i].verao),
                  "entry.837531257": JSON.stringify(mapOverlays[i].outono),
                  "entry.769952164": JSON.stringify(mapOverlays[i].inverno),
                  "entry.1300078572": JSON.stringify(mapOverlays[i].partmed),
                  "entry.986305950": JSON.stringify(mapOverlays[i].partmax),
                  "entry.1654551084": JSON.stringify(mapOverlays[i].modalidade),
                  "entry.834620682": JSON.stringify(
                    mapOverlays[i].moddiferentes
                  ),
                  "entry.553477634": JSON.stringify(mapOverlays[i].quais),
                  "entry.1938012869": JSON.stringify(mapOverlays[i].proteccao),
                  "entry.985236": JSON.stringify(mapOverlays[i].sugestoes),
                  "entry.821907459": JSON.stringify(mapOverlays[i].transporte),
                  "entry.1041184691": JSON.stringify(
                    mapOverlays[i].porqueacesso
                  ),
                  "entry.877936895": JSON.stringify(
                    mapOverlays[i].sugestoesacesso
                  ),
                  "entry.668953545": 0,
                },
                type: "POST",
                dataType: "jsonp",

                statusCode: {
                  0: function () {
                    //Success message
                  },
                  200: function () {
                    //Success Message
                  },
                },
              });
            }
          } else if (mapOverlays[i].type == "polyline") {
            tmpOverlay.path = new Array();

            path = mapOverlays[i].getPath();

            for (var j = 0; j < path.length; j++) {
              tmpOverlay.path[j] = {
                lat: path.getAt(j).lat().toString(),
                lng: path.getAt(j).lng().toString(),
              };
            }
            jQuery.ajax({
              url: "https://web.archive.org/web/20151009000557/https://docs.google.com/a/campus.fct.unl.pt/forms/d/1zqWMiZcv-ZpKjQcawmaV0S555ZLR8N80yl0Lk-43r4I/formResponse",
              data: {
                "entry.1842183354": JSON.stringify(APIpage_autor.value),
                "entry.1720390178": JSON.stringify(APIpage_entid.value),
                "entry.1716839148": JSON.stringify(mapOverlays[i].type),
                "entry.1697832013": JSON.stringify(tmpOverlay.path),
                "entry.1927026631": JSON.stringify(mapOverlays[i].prod_area),
                "entry.631208417": JSON.stringify(mapOverlays[i].grape_vars),
                "entry.1839150385": JSON.stringify(mapOverlays[i].justificacao),
                "entry.1208839541": JSON.stringify(mapOverlays[i].primavera),
                "entry.1080778196": JSON.stringify(mapOverlays[i].verao),
                "entry.837531257": JSON.stringify(mapOverlays[i].outono),
                "entry.769952164": JSON.stringify(mapOverlays[i].inverno),
                "entry.1300078572": JSON.stringify(mapOverlays[i].partmed),
                "entry.986305950": JSON.stringify(mapOverlays[i].partmax),
                "entry.1654551084": JSON.stringify(mapOverlays[i].modalidade),
                "entry.834620682": JSON.stringify(mapOverlays[i].moddiferentes),
                "entry.553477634": JSON.stringify(mapOverlays[i].quais),
                "entry.1938012869": JSON.stringify(mapOverlays[i].proteccao),
                "entry.985236": JSON.stringify(mapOverlays[i].sugestoes),
                "entry.821907459": JSON.stringify(mapOverlays[i].transporte),
                "entry.1041184691": JSON.stringify(mapOverlays[i].porqueacesso),
                "entry.877936895": JSON.stringify(
                  mapOverlays[i].sugestoesacesso
                ),
                "entry.668953545": 0,
              },
              type: "POST",
              dataType: "jsonp",

              statusCode: {
                0: function () {
                  //Success message
                },
                200: function () {
                  //Success Message
                },
              },
            });
          } else if (mapOverlays[i].type == "marker") {
            tmpOverlay.position = {
              lat: mapOverlays[i].getPosition().lat(),
              lng: mapOverlays[i].getPosition().lng(),
            };

            jQuery.ajax({
              url: "https://web.archive.org/web/20151009000557/https://docs.google.com/a/campus.fct.unl.pt/forms/d/1zqWMiZcv-ZpKjQcawmaV0S555ZLR8N80yl0Lk-43r4I/formResponse",
              data: {
                "entry.1842183354": JSON.stringify(APIpage_autor.value),
                "entry.1720390178": JSON.stringify(APIpage_entid.value),
                "entry.1716839148": JSON.stringify(mapOverlays[i].type),
                "entry.1697832013": JSON.stringify(tmpOverlay.position),
                "entry.1927026631": JSON.stringify(mapOverlays[i].prod_area),
                "entry.631208417": JSON.stringify(mapOverlays[i].grape_vars),
                "entry.1839150385": JSON.stringify(mapOverlays[i].justificacao),
                "entry.1208839541": JSON.stringify(mapOverlays[i].primavera),
                "entry.1080778196": JSON.stringify(mapOverlays[i].verao),
                "entry.837531257": JSON.stringify(mapOverlays[i].outono),
                "entry.769952164": JSON.stringify(mapOverlays[i].inverno),
                "entry.1300078572": JSON.stringify(mapOverlays[i].partmed),
                "entry.986305950": JSON.stringify(mapOverlays[i].partmax),
                "entry.1654551084": JSON.stringify(mapOverlays[i].modalidade),
                "entry.834620682": JSON.stringify(mapOverlays[i].moddiferentes),
                "entry.553477634": JSON.stringify(mapOverlays[i].quais),
                "entry.1938012869": JSON.stringify(mapOverlays[i].proteccao),
                "entry.985236": JSON.stringify(mapOverlays[i].sugestoes),
                "entry.821907459": JSON.stringify(mapOverlays[i].transporte),
                "entry.1041184691": JSON.stringify(mapOverlays[i].porqueacesso),
                "entry.877936895": JSON.stringify(
                  mapOverlays[i].sugestoesacesso
                ),
                "entry.668953545": 0,
              },
              type: "POST",
              dataType: "jsonp",

              statusCode: {
                0: function () {
                  //Success message
                },
                200: function () {
                  //Success Message
                },
              },
            });
          }
        }
        alert("Obrigado pelo seu contributo!");
        window.location.href = "http://wine_tasting.csites.fct.unl.pt";
      }

      function enabler() {
        if (
          (document.getElementById("APIpage_autor").value != "") &
          (document.getElementById("APIpage_entid").value != "")
        ) {
          document.getElementById("submeter").disabled = false;
        }
      }

      function formloader() {
        // alert($("prod_areas").val());
        /*
if (document.getElementById("prod_areas").value == "vineyard") {
alert(document.getElementById("prod_areas").value);
document.getElementById("option_prod_items").innerHTML = 'vineyards'
}
else if (document.getElementById("prod_areas").value == "winery") {
alert('winery');
document.getElementById("option_prod_items").innerHTML = 'winery'
}
else{
alert(document.getElementById("prod_areas").option);
document.getElementById("option_prod_items").innerHTML = 'other'
}
*/
      }
    </script>
    <!-- map location searcher-->
    <script id="js/map_search.js">
      /**
       * @license
       * Copyright 2019 Google LLC. All Rights Reserved.
       * SPDX-License-Identifier: Apache-2.0
       */
      // @ts-nocheck TODO remove when fixed
      // This example adds a search box to a map, using the Google Place Autocomplete
      // feature. People can enter geographical searches. The search box will return a
      // pick list containing a mix of places and predicted search terms.
      // This example requires the Places library. Include the libraries=places
      // parameter when you first load the API. For example:
      // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">
      function initAutocomplete(element) {
        /*const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: -33.8688, lng: 151.2195 },
    zoom: 13,
    mapTypeId: "roadmap",
  });*/
        // Create the search box and link it to the UI element.
        const input = element;//document.getElementById("pac-input");
        const searchBox = new google.maps.places.SearchBox(input);

        //map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        // Bias the SearchBox results towards current map's viewport.
        map.addListener("bounds_changed", () => {
          searchBox.setBounds(map.getBounds());
        });
        /*
  let markers = [];*/

        // Listen for the event fired when the user selects a prediction and retrieve
        // more details for that place.
        searchBox.addListener("places_changed", () => {
          const places = searchBox.getPlaces();

          if (places.length == 0) {
            return;
          }

          /*
    // Clear out the old markers.
    markers.forEach((marker) => {
      marker.setMap(null);
    });
    markers = [];
	*/

          // For each place, get the icon, name and location.
          const bounds = new google.maps.LatLngBounds();

          places.forEach((place) => {
            if (!place.geometry || !place.geometry.location) {
              console.log("Returned place contains no geometry");
              return;
            }

            const icon = {
              url: place.icon,
              size: new google.maps.Size(71, 71),
              origin: new google.maps.Point(0, 0),
              anchor: new google.maps.Point(17, 34),
              scaledSize: new google.maps.Size(25, 25),
            };
            /*
      // Create a marker for each place.
      markers.push(
        new google.maps.Marker({
          map,
          icon,
          title: place.name,
          position: place.geometry.location,
        }),
      );*/
            if (place.geometry.viewport) {
              // Only geocodes have viewport.
              bounds.union(place.geometry.viewport);
            } else {
              bounds.extend(place.geometry.location);
            }
          });
          map.fitBounds(bounds);
        });
      }

      //window.initAutocomplete = initAutocomplete;




// on init if user allows location access, this is the error handler
function handleLocationError(browserHasGeolocation) {
    alert("Error: The Geolocation service failed. \nError: Your browser doesn't support geolocation.");
}

// route calculation function
// with alternatives
function calcRoute(directionsService, directionsRenderer) {

  var start = placeOriginLoc;//new google.maps.LatLng(/* starting point latitude and longitude */);
  var end = placeDestinationLoc;//placeLoc; // this is the position of the marker clicked by the user

  
  // set the element with id="end" value to the position of destination marker
  document.getElementById('end').value = end;

  var request = {
    origin: start,
    destination: end,
    travelMode: 'DRIVING', // or 'WALKING', 'BICYCLING', 'TRANSIT'
    provideRouteAlternatives: true
  };
  directionsService.route(request, function(result, status) {
    if (status == 'OK') {
      directionsRenderer.setMap(map);
      // Display the first route
      directionsRenderer.setDirections(result);
      // If you want to display alternative routes, you can do so by creating additional DirectionsRenderer instances
      // remove the markers in markersList from the map and from the list
      for (var i = 0; i < MarkersList.length; i++) {
        MarkersList[i].setMap(null);
      }
      MarkersList = [];

      // Enable the routeSubmit button
      document.getElementById('routeSubmit').disabled = false;

      // store the result in the lastResult variable
      lastResult = result;
    }
  });
  
}


function remRoute(element) {

  // get the index of the active infowindow, we can use targetEL.id to get the index, set the string to integer
  var infowindowIndex = Number(document.getElementsByClassName("targetEl")[0].id.replace('targetEl', ''));
  // get the type of the active infowindow, the name of 'element split by '_' position 0 should be vineyard or winery
  // if element.id contains 'vineyard' then infowindowType is 'vineyard' else it is 'winery'
  var infowindowType = element.id.includes('vineyard') ? 'vineyard' : 'winery';

  // check if element.id + "_@_" + infowindowType + "_nr_" + infowindowIndex already exists in the DirectionsDictionary object
  if (DirectionsDict[element.id + "_@_" + infowindowType + "_nr_" + infowindowIndex]) {
    var distanceResponse = "If you input distances manually your will loose the route information. Do you want to continue, press ok to manually introduce a distance?<br>Press cancel to keep the route information. You will be able to change the route if you want.";  

    if (confirm(distanceResponse) == true) {
// remove the route, the key '''element.id + "_@_" + infowindowType + "_nr_" + infowindowIndex''' and its correnponding value, from the dictionary
delete DirectionsDict[element.id + "_@_" + infowindowType + "_nr_" + infowindowIndex];

// set focus to the 'element' input element
element.focus();
    } else {
     // get the id of the button element: adding '_mapDraw_' to the penultimate entry of element.id.split('_') and join the array with '_'
      var buttonId = element.id.split('_').slice(0, element.id.split('_').length - 1).join('_') + '_mapDraw_' + element.id.split('_')[element.id.split('_').length - 1];


      // click the button element with id=buttonId
      document.getElementById(buttonId).click();

    }

  }

}

// function to call the routing function
function getRoute(element) {
  // get the index of the active infowindow, we can use targetEL.id to get the index, set the string to integer
  var infowindowIndex = Number(document.getElementsByClassName("targetEl")[0].id.replace('targetEl', ''));
  // get the type of the active infowindow, the name of 'element split by '_' position 0 should be vineyard or winery
  // var infowindowType = element.id.split('_')[0];
  // if element.id contains 'vineyard' then infowindowType is 'vineyard' else it is 'winery'
  var infowindowType = element.id.includes('vineyard') ? 'vineyard' : 'winery';

  // // get the id of the input element
  // var inputId = element.id.split('_').slice(0, element.id.split('_').length - 2).join('_') + '_' + element.id.split('_')[element.id.split('_').length - 1];
  // if  element.id.split('_')[element.id.split('_').length - 1] is a digit stored  as a string
  if (!isNaN(element.id.split('_')[element.id.split('_').length - 1])) {
    // get the id of the input element
    var inputId = element.id.split('_').slice(0, element.id.split('_').length - 2).join('_') + '_' + element.id.split('_')[element.id.split('_').length - 1];
  } else {
    // get the id of the input element
    var inputId = element.id.split('_').slice(0, element.id.split('_').length - 1).join('_');
  }



  // get the position of the active infowindow, we can get the overlay position from the mapOverlays array
  var infowindowPosition = window[infowindowType + "_mapOverlays"][infowindowIndex].getPath()
            .getAt(Math.round(vineyard_mapOverlays[infowindowIndex].getPath().getLength() / 3));

  // hide the active infowindow
  google.maps.event.trigger(window[infowindowType + "_mapInfowindows"][infowindowIndex], 'closeclick');
  // hide the div with id="toggle_box"
  document.getElementById("toggle_box").style.display = 'none';

// remove the drag and editable behaviour of all overlays in the array
for (var i = 0; i < vineyard_mapOverlays.length; i++) {
  vineyard_mapOverlays[i].setDraggable(false);
  vineyard_mapOverlays[i].setEditable(false);
}
for (var i = 0; i < winery_mapOverlays.length; i++) {
  winery_mapOverlays[i].setDraggable(false);
  winery_mapOverlays[i].setEditable(false);
}


// display the div with id="floating-panel_directions"
document.getElementById('floating-panel_directions').style.display = 'block';

// set the input with id="start" value to the position of the active infowindow
document.getElementById('start').value = infowindowPosition;

  // check if element.id + "_@_" + infowindowType + "_nr_" + infowindowIndex already exists in the DirectionsDictionary object
  if (DirectionsDict[inputId + "_@_" + infowindowType + "_nr_" + infowindowIndex]) {
    // if it exists, set the lastResult to the value of the key in the DirectionsDictionary object
    lastResult = DirectionsDict[inputId + "_@_" + infowindowType + "_nr_" + infowindowIndex];
    // set the value of the input with id="start" to the position of the active infowindow
    document.getElementById('start').value = lastResult.request.origin;
    // set the value of the input with id="end" to the position of the active infowindow
    document.getElementById('end').value = lastResult.request.destination;
    // enable the routeSubmit button
    document.getElementById('routeSubmit').disabled = false;
    // remove the markers in MarkersList from the map

    directionsRenderer.setMap(map);
      // Display the first route
      directionsRenderer.setDirections(lastResult);
      DirectionsDict[inputId + "_@_" + infowindowType + "_nr_" + infowindowIndex] = {};
  } else {
// set the origin marker position to the position of the active infowindow
placeOriginLoc = infowindowPosition;

// diplay a marker with markerOptions: {icon: './img/Origin.png'} in the position of the active infowindow
// if (originMarker) {
//   originMarker.setMap(null);
// }
originMarker = new google.maps.Marker({
  position: infowindowPosition,
  map: map,
  icon: './img/Origin.png'
});

MarkersList.push(originMarker);
// click the elemnt with id="originMarkerStart"
document.getElementById('destinationMarkerStart').click();


// add a key to the DirectionsDictionary object with a empty dictionary as value
DirectionsDict[inputId + "_@_" + infowindowType + "_nr_" + infowindowIndex] = {};
// MarkersDict[element.id + "_@_" + infowindowType + "_nr_" + infowindowIndex] = {};

}
}


function routeSubmit() {
      // find the key in the DirectionsDictionary object that contains an empty dictionary as value
      var key = Object.keys(DirectionsDict).find(key => Object.keys(DirectionsDict[key]).length === 0);

      DirectionsDict[key] = lastResult;

      
      // set all overlays in the map to draggable and editable
      for (var i = 0; i < vineyard_mapOverlays.length; i++) {
        vineyard_mapOverlays[i].setDraggable(true);
        vineyard_mapOverlays[i].setEditable(true);
      }
      for (var i = 0; i < winery_mapOverlays.length; i++) {
        winery_mapOverlays[i].setDraggable(true);
        winery_mapOverlays[i].setEditable(true);
      }
    
      // open the infowindow window[key.split('_@_')[1].split('_nr_')[0] + "_mapInfowindows"][key.split('_nr_')[1]]
      google.maps.event.trigger(window[key.split('_@_')[1].split('_nr_')[0] + "_mapOverlays"][Number(key.split('_nr_')[1])], 'click');


      // get the distance of the route and set the value of the input with id=key.split('_@_')[0]
      document.getElementById(key.split('_@_')[0]).value = Number(lastResult.routes[0].legs[0].distance.text.split(' ')[0].replace(',', '.'));
      // scroll the input element with id=key.split('_@_')[0] to the top of the page
      document.getElementById(key.split('_@_')[0]).scrollIntoView(true);

      // remove the route and markers from the map
      directionsRenderer.setMap(null);
      
 

      lastResult = null;
      document.getElementById("start").value = "";
      document.getElementById("end").value = "";
      document.getElementById("routeSubmit").disabled = true;
      document.getElementById("floating-panel_directions").style.display = "none";



}
function areaSubmit() {

  const infowindowType = areasDictKey.includes('vineyard') ? 'vineyard' : 'winery';
  // const infowindow_to_display = window[infowindowType + "_mapInfowindows"][infowindowIndex];

  // display the infowindow 
  // google.maps.event.trigger(infowindow_to_display, 'click');
  // infowindow_to_display.setPosition(window[infowindowType + "_mapOverlays"][infowindowIndex].getPath().getAt(Math.round(window[infowindowType + "_mapOverlays"][infowindowIndex].getPath().getLength() / 3)));
  // infowindow_to_display.open(map);

  google.maps.event.trigger(window[infowindowType + "_mapOverlays"][infowindowIndex], 'click');

  // remove the overlay in the areaDictKey position from the map
  AreasDict[areasDictKey].polygon.setMap(null);

    // hide the div with id="floating-panel_areas"
  document.getElementById('floating-panel_areas').style.display = 'none';

  // set the value of the input element with id=areasDictKey to the percent in the element with id="areaPercent"
  document.getElementById(areasDictKey).value = document.getElementById('areaPercent').value;
  // scroll the input element with id=areasDictKey to the top of the page
  document.getElementById(areasDictKey).scrollIntoView(true);

  // set the value of the element with id areaAbsolute and areaPercent to ''
  document.getElementById('areaAbsolute').value = '';
  document.getElementById('areaPercent').value = '';

  // disable the areaSubmit button
  document.getElementById('areaSubmit').disabled = true;

//   // add the click event listener for all overlays in the array
//   for (var i = 0; i < window[infowindowType + "_mapOverlays"].length; i++) {
//     // infowindowType to camelCase
//     var infowindowTypeCamelCase = infowindowType.charAt(0).toUpperCase() + infowindowType.slice(1);
//     var infowindow = window[infowindowType + "_mapInfowindows"][i];
//     var dzenho = window[infowindowType + "_mapOverlays"][i];
//     google.maps.event.addListener(vineyard_mapOverlays[i], 'click', function() {
        
//         window['isNew' + infowindowTypeCamelCase + 'Overlay'] = false;
//         event.preventDefault();

//         // hide map controls
//         map.set("zoomControl", false);
//         map.set("mapTypeControl", false);
//         map.set("panControl", false);

//         // hide the main container
//         document.getElementById("toggle_box").style.display = "none";

//         vineyard_drawingManager.setDrawingMode(null);
//         winery_drawingManager.setDrawingMode(null);


//         // ---------------
//         if (dzenho.strokeColor == "#f7f701") {          
//           infowindow.open(map, dzenho);

//           $(".prod_areas").addClass("hidesudo");
//           $(".acessos").addClass("showsudo");
// } else if (dzenho.strokeColor == "#38c4f2") {
//           infowindow.open(map, dzenho);

//           $(".prod_areas").addClass("hidesudo");
//           $(".acessos").addClass("showsudo");
//         } else {}

//     });
//   }

  infowindowIndex = null;
  areasDictKey = null;

}
function remArea(element) {
  // check if element.id already exists in the AreasDict object
  if (AreasDict[element.id]) {

    var areaResponse = "If you input areas manually your will loose the polygon information. Do you want to continue, press ok to manually introduce an area?<br>Press cancel to keep the existing area polygon. You will be able to polygon if you want.";  

if (confirm(areaResponse) == true) {
  // remove the polygon, the key element.id and its correnponding value, from the dictionary
  delete AreasDict[element.id];

  // set focus to the 'element' input element
  element.focus();
} else {
  // get the id of the button element: adding '_mapDraw_' to the penultimate entry of element.id.split('_') and join the array with '_'
  var buttonId = element.id.split('_').slice(0, element.id.split('_').length - 1).join('_') + '_mapDraw_' + element.id.split('_')[element.id.split('_').length - 1];

  // click the button element with id=buttonId
  document.getElementById(buttonId).click();
}

  }
}

function pathArea(path) {
  const points = [];
  for(let i = 0; i < path.getLength(); ++i) {
    points.push([path.getAt(i).lng(), path.getAt(i).lat()]);
  }
  points.push([path.getAt(0).lng(), path.getAt(0).lat()]);
  const polygon = turf.polygon([points]);
  const totalArea = turf.area(polygon);
  return totalArea;
}

function getArea(element) {
  // get the index of the active infowindow, we can use targetEL.id to get the index, set the string to integer
  infowindowIndex = Number(document.getElementsByClassName("targetEl")[0].id.replace('targetEl', ''));
  // get the type of the active infowindow, the name of 'element split by '_' position 0 should be vineyard or winery
  // if element.id contains 'vineyard' then infowindowType is 'vineyard' else it is 'winery'
  var infowindowType = element.id.includes('vineyard') ? 'vineyard' : 'winery';

  // if  element.id.split('_')[element.id.split('_').length - 1] is a digit stored  as a string
  if (!isNaN(element.id.split('_')[element.id.split('_').length - 1])) {
    // get the id of the input element
    var inputId = element.id.split('_').slice(0, element.id.split('_').length - 2).join('_') + '_' + element.id.split('_')[element.id.split('_').length - 1];
  } else {
    var inputId = element.id.split('_').slice(0, element.id.split('_').length - 1).join('_');
  }



  areasDictKey = inputId;


  // get the position of the active infowindow, we can get the overlay position from the mapOverlays array
  var infowindowPosition = window[infowindowType + "_mapOverlays"][infowindowIndex].getPath()
            .getAt(Math.round(vineyard_mapOverlays[infowindowIndex].getPath().getLength() / 3));

  // hide the active infowindow
  google.maps.event.trigger(window[infowindowType + "_mapInfowindows"][infowindowIndex], 'closeclick');
  // hide the div with id="toggle_box"
  document.getElementById("toggle_box").style.display = 'none';

  // remove the drag and editable behaviour of all overlays in the array
  for (var i = 0; i < vineyard_mapOverlays.length; i++) {
    vineyard_mapOverlays[i].setDraggable(false);
    vineyard_mapOverlays[i].setEditable(false);
  }
  for (var i = 0; i < winery_mapOverlays.length; i++) {
    winery_mapOverlays[i].setDraggable(false);
    winery_mapOverlays[i].setEditable(false);
  }

  // // remove the click event listener for all overlays in the array
  // for (var i = 0; i < window[infowindowType + "_mapOverlays"].length; i++) {
  //   google.maps.event.clearListeners(window[infowindowType + "_mapOverlays"][i], 'click');
  // }

  // display the div with id="floating-panel_floating-panel_areas"
  document.getElementById('floating-panel_areas').style.display = 'block';

  // check if areasDictKey already exists in the AreasDict object
  if (AreasDict[areasDictKey]) {
    // if it exists, set the lastResult to the value of the key in the AreasDict object
    lastResult = AreasDict[areasDictKey];
    // set the value of the input with id="areaPercent" to the value of the key in the AreasDict object
    document.getElementById('areaAbsolute').value = lastResult.area.toFixed(2);
    // set the value of the input with id="areaPercent" to the value of the key in the AreasDict object
    document.getElementById('areaPercent').value = lastResult.percent.toFixed(2);
    // set the polygon in the AreasDict object to the map
    lastResult.polygon.setMap(map);
    // enable the areaSubmit button
    document.getElementById('areaSubmit').disabled = false;
  } else {

  // click the button with id="areaStart"
  document.getElementById('areaStart').click();
  }
}
function sourceSubmit() {

  var infowindowType = areasDictKey.includes('vineyard') ? 'vineyard' : 'winery';

  //Show the infowindow
  google.maps.event.trigger(window[infowindowType + "_mapOverlays"][infowindowIndex], 'click');

  // scroll the input element with id=areasDictKey to the top of the page
  document.getElementById(areasDictKey).scrollIntoView(true);

  // set the value of the input element with id=areasDictKey to the value of the element with id="source_search"
  document.getElementById(areasDictKey).value = document.getElementById('source_search').value;	

  // disableable the submit button with id="sourceSubmit"
  document.getElementById("sourceSubmit").disabled = true;
  // set the value of the element with id source_search to ''
  document.getElementById('source_search').value = '';
  // hide the div with id="floating-panel_sources"
  document.getElementById('floating-panel_sources').style.display = 'none';

  // Empty the MarkersList: remove the markers in MarkersList from the map
  for (var i = 0; i < MarkersList.length; i++) {
    MarkersList[i].setMap(null);
  }
  //set the MarkersList to an empty array
  MarkersList = [];



  // set the var areasDictKey to null
  areasDictKey = null;
  // set the var infowindowIndex to null
  infowindowIndex = null;



}

function getSource(element) {
  // get the index of the active infowindow, we can use targetEL.id to get the index, set the string to integer
  infowindowIndex = Number(document.getElementsByClassName("targetEl")[0].id.replace('targetEl', ''));
  // get the type of the active infowindow, the name of 'element split by '_' position 0 should be vineyard or winery
  // if element.id contains 'vineyard' then infowindowType is 'vineyard' else it is 'winery'
  var infowindowType = element.id.includes('vineyard') ? 'vineyard' : 'winery';

  // if  element.id.split('_')[element.id.split('_').length - 1] is a digit stored  as a string
  if (!isNaN(element.id.split('_')[element.id.split('_').length - 1])) {
    // get the id of the input element
    var inputId = element.id.split('_').slice(0, element.id.split('_').length - 2).join('_') + '_' + element.id.split('_')[element.id.split('_').length - 1];
  } else {
    // get the id of the input element
    var inputId = element.id.split('_').slice(0, element.id.split('_').length - 1).join('_');
  }

  // // get the id of the input element
  // var inputId = element.id.split('_').slice(0, element.id.split('_').length - 2).join('_') + '_' + element.id.split('_')[element.id.split('_').length - 1];

  // set the value of the input element with id=inputId to the value of the element with id="source"
  areasDictKey = inputId;

  // get the position of the active infowindow, we can get the overlay position from the mapOverlays array
  var infowindowPosition = window[infowindowType + "_mapOverlays"][infowindowIndex].getPath()
            .getAt(Math.round(vineyard_mapOverlays[infowindowIndex].getPath().getLength() / 3));

  // hide the active infowindow
  google.maps.event.trigger(window[infowindowType + "_mapInfowindows"][infowindowIndex], 'closeclick');
  // hide the div with id="toggle_box"
  document.getElementById("toggle_box").style.display = 'none';

  // remove the drag and editable behaviour of all overlays in the array
  for (var i = 0; i < vineyard_mapOverlays.length; i++) {
    vineyard_mapOverlays[i].setDraggable(false);
    vineyard_mapOverlays[i].setEditable(false);
  }
  for (var i = 0; i < winery_mapOverlays.length; i++) {
    winery_mapOverlays[i].setDraggable(false);
    winery_mapOverlays[i].setEditable(false);
  }

  // display the div with id="floating-panel_sources"
  document.getElementById('floating-panel_sources').style.display = 'block';

  // click the button with id="sourceStart"
  document.getElementById('SourceStart').click();


}

</script>
  </head>

  <body onload="mapInitialize()">
    //-------------------------------------------------------------------------------------------------------------------------------
    <div
      id="toggle_box"
      style="
        position: absolute;
        top: 0px;
        left: 0px;
        width: 15%;
        height: 95%;
        padding: 5px;
        background: rgba(240, 248, 255, 0.9);
        border: 5px solid rgba(6, 80, 73, 1);
        border-radius: 12px;
        z-index: 5;
      "
    >
    <div style="padding: 5px; background: rgba(240, 248, 255, 0.9); border: 2px solid rgba(6, 80, 73, 1); border-radius: 12px;">
      <span >Type in the box below to navigate to a specific location:</span>
      <br>
      <br>

      <input
        id="pac-input"
        class="controls"
        type="text"
        size="32vi"
        placeholder="Escolha uma localização aqui."
        oninput="initAutocomplete(this)"
      />
    </div>
    <div id="mainContainer" style="position: relative; top: -1.2em;">
      <p style="font-size: 2em;font-weight: 700; line-height: 1em;">Wine tasting experience form.</p>
      <p style="position: relative; top: -1.6em;">
        Clicking the first <span style="display: inline-block; width: 16px; height: 16px; overflow: hidden; position: relative;"><img alt="" src="https://maps.gstatic.com/mapfiles/drawing.png" draggable="false" style="position: absolute; left: 0px; top: -64px; user-select: none; border: 0px; padding: 0px; margin: 0px; max-width: none; width: 16px; height: 192px;"></span> icon below you can draw all your wine production plots on the map, you will be prompted to answer the forms for each plot, each plot will be added to a list below the icons.</p>
        <p style="position: relative; top: -2.2em;">Aftwerwords, by clicking in the second <span style="display: inline-block; width: 16px; height: 16px; overflow: hidden; position: relative;"><img alt="" src="https://maps.gstatic.com/mapfiles/drawing.png" draggable="false" style="position: absolute; left: 0px; top: -64px; user-select: none; border: 0px; padding: 0px; margin: 0px; max-width: none; width: 16px; height: 192px;"></span>  icon you will be able to draw the area(s) pertainig your wineries and subsequently answer the form related to vinification and bottling.</p>
        <p style="position: relative; top: -3em;">By clicking any of the <span style="display: inline-block; width: 16px; height: 16px; overflow: hidden; position: relative;"><img alt="" src="https://maps.gstatic.com/mapfiles/drawing.png" draggable="false" style="position: absolute; left: 0px; top: -144px; user-select: none; border: 0px; padding: 0px; margin: 0px; max-width: none; width: 16px; height: 192px;"></span> icons you can grab and moove the map at will.</p>
      

      <div id="drawingControlContainers" style="position: relative; top: -3.5em;">
        <div id="vineyard_drawingControlContainer" style="display: grid;">
          <span style="display: inline-block">
            Click <span style="display: inline-block;" id="vineyardStart_Button_container"></span> to draw a <b>vineyard plot</b>.</span><span>Click <span style="display: inline-block;" id="vineyardStop_Button_container"></span> to <b>disble drawing</b>.</span>
            <!-- <span style="display: inline-block">
              Click <span style="display: inline-block;"><div style="width: 16px; height: 16px; overflow: hidden; position: relative;"><img alt="" src="https://maps.gstatic.com/mapfiles/drawing.png" draggable="false" style="position: absolute; left: 0px; top: -64px; user-select: none; border: 0px; padding: 0px; margin: 0px; max-width: none; width: 16px; height: 192px;"></div></span> to draw a <b>vineyard plot</b>.</span><span>Click <span style="display: inline-block;"><div style="width: 16px; height: 16px; overflow: hidden; position: relative;"><img alt="" src="https://maps.gstatic.com/mapfiles/drawing.png" draggable="false" style="position: absolute; left: 0px; top: -144px; user-select: none; border: 0px; padding: 0px; margin: 0px; max-width: none; width: 16px; height: 192px;"></div></span> to <b>disble drawing</b>.</span> -->
            <!-- <button
              id="vineyard_drawButton"
              class="vineyard_drawButton drawButton"
              draggable="false"
              aria-label="Draw a shape"
              title="Draw a shape"
              type="button"
              role="menuitemradio"
              aria-checked="false"
            >
              <span style="display: inline-block"
                ><div
                  style="
                    display: inline-flex;
                    width: fit-content;
                    height: 16px;
                    overflow: hidden;
                    position: relative;
                  "
                >
                  <p>Select to draw grape land plots</p>
                  <img
                    style="
                      position: relative;
                      left: 0px;
                      top: -64px;
                      user-select: none;
                      border: 0px;
                      padding: 0px;
                      margin: 0px;
                      max-width: none;
                      width: 16px;
                      height: 192px;
                    "
                    alt=""
                    src="https://maps.gstatic.com/mapfiles/drawing.png"
                    draggable="false"
                  /></div
              ></span>
            </button> -->
          </br>
            <div id="vineyard_dynamicContent" style="max-height: 11em; overflow-y: auto;">
            <!-- Placeholder for dynamic table/list -->
            <ol id="vineyard_list"></ol>              
            </div>

          </div>

          <div id="winery_drawingControlContainer"  style="display: grid;">

            <span style="display: inline-block">
              Click <span style="display: inline-block;" id="wineryStart_Button_container"></span> to draw a <b>winery site</b>.</span><span>Click <span style="display: inline-block;" id="wineryStop_Button_container"></span> to <b>disable drawing</b>.</span>

<br>
            <div id="winery_dynamicContent" style="max-height: 11em; overflow-y: auto;">
            <!-- Placeholder for dynamic table/list -->
            <ol id="winery_list"></ol>
            </div>

          </div>
        </div>
        <!-- Placeholder for drawing control -->
      </div>
    </div>
    //-------------------------------------------------------------------------------------------------------------------------------

    <div id="floating-panel_directions">
      <table>
          <thead>
        <tr>
          <th>Origin</th>
          <th>Destination</th>
          <th>Submit</th>
          </tr>
          </thead>
          <tbody>
              <tr>
                  <td><div id="originMarker_container" style="display: inline-flex;"></div></td>
                  <td><div id="destinationMarker_container" style="display: inline-flex;"></div></td>
                  <td rowspan="2">
                    <button id="routeSubmit" onclick="routeSubmit()" disabled>Submit</button>
                </td>
              </tr>
          <tr>
          <td>
              <input
              id="start"
              class="controls"
              type="text"
              size="28dvw"
              placeholder="Choose start location here."
              oninput="initAutocomplete(this)"
            />
          </td>
          <td>
              <input
              id="end"
              class="controls"
              type="text"
              size="28dvw"
              placeholder="Choose end location here."
              oninput="initAutocomplete(this)"
              />
          </td>

          </tr>
          </tbody>
      </table>
    </div>

    <div id="floating-panel_areas">
      <table>
        <thead>
          <tr>
            <th>Draw the area</th>
            <th>Area</th>
            <th>Percent of plot</th>
            <th>Submit</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="areaStart_container"></td>
            <td id="area_container">
<input type="number" disabled="disabled" id="areaAbsolute" name="areaAbsolute"/>
<select>
  <option selected disabled>ha</option>
</select>
            </td>
            <td id="areaPercent_container">
<input type="number" disabled="disabled" id="areaPercent" name="areaPercent"/>
<select>
  <option selected disabled>%</option>
</select>

            </td>
            <td>
              <button id="areaSubmit" onclick="areaSubmit()" disabled="">Submit</button>
            </td>

            <td id="areaStop_container"></td>



            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="floating-panel_sources">
      <table>
          <thead>
        <tr>
          <th>Source</th>
          <th>Submit</th>
          </tr>
          </thead>
          <tbody>
              <tr>
                  <td>
                    <div id="SourceMarker_container" style="display: inline-flex;"></div>
                  </td>
                  <td colspan="2">
                    <button id="sourceSubmit" onclick="sourceSubmit()" disabled>Submit</button>
                </td>
              </tr>
          <tr>
          <td>
              <input id="source_search" class="controls" type="text" size="28dvw" placeholder="Choose end location here." oninput="initAutocomplete(this)">
          </td>

          </tr>
          </tbody>
      </table>
    </div>


    <!--                                                   -->
    <!-- map div container -->
    <!--<div id="map_canvas" style="height:100%; "></div>-->
    <div id="map_canvas" class="mapcanvasstyle"></div>




  
  






    <div class="form-horizontal save-form mainDiv" id="vineyard_main_form" name="vineyard_main_form" style="display: block; width: inherit; height: inherit;">
      <div class="targetEl"></div>
      <div class="form-actions">
        <button type="button" class="btn-primary" id="apagar">Apagar</button>
        <button type="button" id="aceitar" class="botaoaceitar">Aceitar</button>
      </div>
    </div>

    <div
      id="google_translate_element"
      style="position: absolute; left: 15px; bottom: 15px; z-index: 2"
    ></div>
    <!--<textarea id="mapData" style="width:100%; height:300px"></textarea>-->
    <script>
      // JavaScript to add functionality to the custom button
      // document
      //   .getElementById("vineyard_drawButton")
      //   .addEventListener("click", function () {

      //     wine_tasting.initialize();
      //     // document.getElementsByClassName('vineyard_drawButton')[0].addEventListener('click', function() {
      //     // Set the drawing manager to polygon mode
      //     console.log("#0");
      //     console.log(vineyard_drawingManager);
      //     vineyard_drawingManager.setDrawingMode(
      //       google.maps.drawing.OverlayType.POLYGON
      //     );

      //     // to do: add disabled to the other drawing button
      //             - set the input element for geocoding innerHTML to ""
      //   });

      // // JavaScript to add functionality to the custom button
      // document
      //   .getElementById("winery_drawButton")
      //   .addEventListener("click", function () {
      //     // document.getElementsByClassName('winery_drawButton')[0].addEventListener('click', function() {
      //     // Set the drawing manager to polygon mode
      //     winery_drawingManager.setDrawingMode(
      //       google.maps.drawing.OverlayType.POLYGON
      //     );

      //     // to do: add disabled to the other drawing button
      //   });
    </script>

    <script>
//       alert("Screen Width: " + window.innerWidth + ", Screen Height: " + window.innerHeight);
//       var screenWidth = window.screen.width * window.devicePixelRatio;
// var screenHeight = window.screen.height * window.devicePixelRatio;
// alert("Screen Width: " + screenWidth + ", Screen Height: " + screenHeight);
// function calculateDPI() {
//     var div = document.createElement("div");
//     div.style.width="1in";
//     div.style.height="1in";
//     div.style.position="absolute";
//     div.style.left="-100%";
//     div.style.top="-100%";
//     document.body.appendChild(div);
//     var dpi = div.offsetWidth;
//     document.body.removeChild(div);
//     return dpi;
// }

// alert("The screen DPI is approximately: " + calculateDPI());

// alert("the screen DPI is: " + window.devicePixelRatio);
    </script>

  </body>
</html>
<!--http://gmaps-samples-v3.googlecode.com/svn/trunk/smartinfowindow/smartinfowindow.html-->

<!-- d_resource: 368.455 -->
